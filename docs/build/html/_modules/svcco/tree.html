
<!DOCTYPE html>

<html lang="python">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>svcco.tree &#8212; SVCCO 0.5.52 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SVCCO 0.5.52 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">svcco.tree</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for svcco.tree</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pyvista</span> <span class="k">as</span> <span class="nn">pv</span>
<span class="kn">import</span> <span class="nn">vtk</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span>
<span class="kn">from</span> <span class="nn">.implicit.implicit</span> <span class="kn">import</span> <span class="n">surface</span>
<span class="kn">from</span> <span class="nn">.branch_addition.check</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.branch_addition.close</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.branch_addition.basis</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.branch_addition.calculate_length</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.branch_addition.calculate_radii</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.branch_addition.set_root</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.branch_addition.add_edge</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.branch_addition.add_bifurcation</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.branch_addition.add_branches_v3</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.forest_utils.connect</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.forest_utils.smooth</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.forest_utils.compete_add</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.sv_interface.get_sv_data</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.sv_interface.options</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.sv_interface.build_files</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.sv_interface.waveform</span> <span class="kn">import</span> <span class="n">generate_physiologic_wave</span><span class="p">,</span> <span class="n">wave</span>
<span class="kn">from</span> <span class="nn">.sv_interface.build_results</span> <span class="kn">import</span> <span class="n">make_results</span>
<span class="kn">from</span> <span class="nn">.sv_interface.view_0d_result_plots</span> <span class="kn">import</span> <span class="n">view_plots</span>
<span class="kn">from</span> <span class="nn">.sv_interface.build_0d_run_script</span> <span class="kn">import</span> <span class="n">run_0d_script</span>
<span class="kn">from</span> <span class="nn">.sv_interface.locate</span> <span class="kn">import</span> <span class="n">locate_0d_solver</span><span class="p">,</span> <span class="n">locate_1d_solver</span>
<span class="kn">from</span> <span class="nn">.sv_interface.export_3d_only</span> <span class="kn">import</span> <span class="n">export_3d_only</span>
<span class="kn">from</span> <span class="nn">.collision.collision</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.utils.gcode.gcode</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">tetgen</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">splev</span><span class="p">,</span> <span class="n">splprep</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">pymeshfix</span>
<span class="kn">from</span> <span class="nn">.sv_interface</span> <span class="kn">import</span> <span class="n">ROM</span>
<span class="kn">from</span> <span class="nn">.utils.remeshing.remesh</span> <span class="kn">import</span> <span class="n">remesh_surface</span>
<span class="c1">#from wrapt_timeout_decorator import *</span>
<span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
<span class="kn">from</span> <span class="nn">tkinter.filedialog</span> <span class="kn">import</span> <span class="n">askopenfilename</span>

<div class="viewcode-block" id="get"><a class="viewcode-back" href="../../svcco.html#svcco.tree.get">[docs]</a><span class="k">def</span> <span class="nf">get</span><span class="p">():</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
    <span class="n">root</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">askopenfilename</span><span class="p">()</span>
    <span class="n">root</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">filename</span></div>


<div class="viewcode-block" id="tree"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree">[docs]</a><span class="k">class</span> <span class="nc">tree</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Data structure:\n</span>
<span class="sd">    index: 0:2   -&gt; proximal node coordinates \n</span>
<span class="sd">    index: 3:5   -&gt; distal node coordinates \n</span>
<span class="sd">    index: 6:8   -&gt; unit basis U (all) \n</span>
<span class="sd">    index: 9:11  -&gt; unit basis V (all) \n</span>
<span class="sd">    index: 12:14 -&gt; unit basis W (axial direction) (all) \n</span>
<span class="sd">    index: 15,16 -&gt; children (-1 means no child) \n</span>
<span class="sd">    index: 17    -&gt; parent (NA) \n</span>
<span class="sd">    index: 18    -&gt; proximal node index (only real edges) \n</span>
<span class="sd">    index: 19    -&gt; distal node index (only real edges) \n</span>
<span class="sd">    index: 20    -&gt; length (path length) \n</span>
<span class="sd">    index: 21    -&gt; radius (what are the units?) \n</span>
<span class="sd">    index: 22    -&gt; flow (NA) \n</span>
<span class="sd">    index: 23    -&gt; left bifurcation (NA) \n</span>
<span class="sd">    index: 24    -&gt; right bifurcation (NA) \n</span>
<span class="sd">    index: 25    -&gt; reduced resistance (NA) \n</span>
<span class="sd">    index: 26    -&gt; depth (NA) \n</span>
<span class="sd">    index: 27    -&gt; reduced downstream length (NA) \n</span>
<span class="sd">    index: 28    -&gt; root radius scaling factor (same as edge for intermediate) \n</span>
<span class="sd">    index: 29    -&gt; edge that subedge belongs to (if actual edge; self pointer) \n</span>
<span class="sd">    index: 30    -&gt; self identifying index (-1 if intermediate) \n</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#self.parameters = {&#39;gamma&#39;   : 3.0,</span>
        <span class="c1">#                   &#39;lambda&#39;  : 2.0,</span>
        <span class="c1">#                   &#39;mu&#39;      : 1.0,</span>
        <span class="c1">#                   &#39;nu&#39;      : 3.6/100,</span>
        <span class="c1">#                   &#39;Pperm&#39;   : 100*1333.22,</span>
        <span class="c1">#                   &#39;Pterm&#39;   : 60*1333.22,</span>
        <span class="c1">#                   &#39;Qterm&#39;   : (0.125)/60,</span>
        <span class="c1">#                   &#39;edge_num&#39;: 0}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">31</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_buffer</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fraction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_assumptions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;search&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;constraints&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;local_optimize&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;collision&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;close_time&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;search_1&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;search_2&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;search_3&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;search_4&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;add_time&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;add_1&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;add_2&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;add_3&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;add_4&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;total&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;brute_optimize&#39;</span><span class="p">:</span> <span class="p">[],</span>
                     <span class="s1">&#39;method_optimize&#39;</span><span class="p">:</span> <span class="p">[],</span>
                     <span class="s1">&#39;depth&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;method_time&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;brute_time&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;brute_x_value&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;brute_value&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;method_x_value&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;method_value&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;truth_x_value&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;truth_value&#39;</span><span class="p">:[]}</span>

<div class="viewcode-block" id="tree.set_parameters"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.set_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">set_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span><span class="mf">3.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;lambda&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lambda&#39;</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mu&#39;</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nu&#39;</span><span class="p">,</span><span class="mf">3.6</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Pperm&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Pperm&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span><span class="o">*</span><span class="mf">1333.22</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Pterm&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Pterm&#39;</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span><span class="o">*</span><span class="mf">1333.22</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Qterm&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Qterm&#39;</span><span class="p">,</span><span class="mf">0.125</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;edge_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_num&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rho&#39;</span><span class="p">,</span><span class="mf">1.06</span><span class="p">)</span></div>

<div class="viewcode-block" id="tree.set_assumptions"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.set_assumptions">[docs]</a>    <span class="k">def</span> <span class="nf">set_assumptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">homogeneous</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;homogeneous&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directed</span>    <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;directed&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convex</span>      <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;convex&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hollow</span>      <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hollow&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span>   <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dimension&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clamped_root</span><span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;clamped_root&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonconvex_counter</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="tree.show_assumptions"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.show_assumptions">[docs]</a>    <span class="k">def</span> <span class="nf">show_assumptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;homogeneous : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">homogeneous</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;directed    : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directed</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;convex      : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convex</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hollow      : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hollow</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dimension   : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clamped root: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clamped_root</span><span class="p">))</span></div>

<div class="viewcode-block" id="tree.set_boundary"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.set_boundary">[docs]</a>    <span class="k">def</span> <span class="nf">set_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">boundary</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">=</span> <span class="n">boundary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fraction</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">volume</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="mi">20</span></div>

<div class="viewcode-block" id="tree.set_root"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.set_root">[docs]</a>    <span class="k">def</span> <span class="nf">set_root</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">limit_high</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">limit_low</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">niter</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
        <span class="n">Qterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Qterm&#39;</span><span class="p">]</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span>
        <span class="n">nu</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span>
        <span class="n">Pperm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Pperm&#39;</span><span class="p">]</span>
        <span class="n">Pterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Pterm&#39;</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">set_root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="p">,</span><span class="n">Qterm</span><span class="p">,</span>
                          <span class="n">gamma</span><span class="p">,</span><span class="n">nu</span><span class="p">,</span><span class="n">Pperm</span><span class="p">,</span><span class="n">Pterm</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fraction</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">homogeneous</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">convex</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">directed</span><span class="p">,</span>
                          <span class="n">start</span><span class="p">,</span><span class="n">direction</span><span class="p">,</span><span class="n">limit_high</span><span class="p">,</span><span class="n">limit_low</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                          <span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">niter</span><span class="o">=</span><span class="n">niter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_division_map</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_division_index</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;edge_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span></div>
        <span class="c1">#self.sub_division_map = [-1]</span>
        <span class="c1">#self.sub_division_index = np.array([0])</span>

<div class="viewcode-block" id="tree.add"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">low</span><span class="p">,</span><span class="n">high</span><span class="p">,</span><span class="n">isforest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">radius_buffer</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">):</span>
        <span class="n">vessel</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">sub_division_map</span><span class="p">,</span><span class="n">sub_division_index</span><span class="p">,</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">add_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">low</span><span class="p">,</span><span class="n">high</span><span class="p">,</span><span class="n">threshold_exponent</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                                                     <span class="n">threshold_adjuster</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span><span class="n">all_max_attempts</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                                                                     <span class="n">max_attemps</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">sampling</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">max_skip</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                                                     <span class="n">flow_ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">radius_buffer</span><span class="o">=</span><span class="n">radius_buffer</span><span class="p">,</span>
                                                                     <span class="n">isforest</span><span class="o">=</span><span class="n">isforest</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isforest</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vessel</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">sub_division_map</span><span class="p">,</span><span class="n">sub_division_index</span><span class="p">,</span><span class="n">threshold</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;edge_num&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sub_division_map</span> <span class="o">=</span> <span class="n">sub_division_map</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sub_division_index</span> <span class="o">=</span> <span class="n">sub_division_index</span></div>

<div class="viewcode-block" id="tree.n_add"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.n_add">[docs]</a>    <span class="k">def</span> <span class="nf">n_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_points</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">pick</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">40</span><span class="o">*</span><span class="n">n</span><span class="p">,</span><span class="n">homogeneous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng_points</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Adding vessels&#39;</span><span class="p">):</span>
            <span class="c1">#for i in range(n):</span>
            <span class="c1">#self.rng_points = self.rng_points.tolist()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span></div>

        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;search&#39;][1:],label=&#39;search time&#39;)</span>
        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;constraints&#39;][1:],label=&#39;constraint time&#39;)</span>
        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;local_optimize&#39;][1:],label=&#39;local time&#39;)</span>
        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;collision&#39;][1:],label=&#39;collision time&#39;)</span>
        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;search_1&#39;][1:],label=&#39;search 1 time&#39;)</span>
        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;search_2&#39;][1:],label=&#39;search 2 time&#39;)</span>
        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;search_3&#39;][1:],label=&#39;search 3 time&#39;)</span>
        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;search_4&#39;][1:],label=&#39;search 4 time&#39;)</span>
        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;close_time&#39;][1:],label=&#39;close_time time&#39;)</span>
        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;add_time&#39;][1:],label=&#39;add_time&#39;)</span>
        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;add_1&#39;][1:],label=&#39;add_1&#39;)</span>
        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;add_2&#39;][1:],label=&#39;add_2&#39;)</span>
        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;add_3&#39;][1:],label=&#39;add_3&#39;)</span>
        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;add_4&#39;][1:],label=&#39;add_4&#39;)</span>
        <span class="c1">#plt.plot(list(range(len(self.time[&#39;search&#39;][1:]))),self.time[&#39;total&#39;][1:],label=&#39;total&#39;)</span>
        <span class="c1">#plt.ylim([0,0.1])</span>
        <span class="c1">#plt.legend()</span>
        <span class="c1">#plt.show()</span>

<div class="viewcode-block" id="tree.show"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">surface</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">vessel_colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">background_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
             <span class="n">resolution</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">show_segments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">surface_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">other_surface_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">):</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">actors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vessel_colors</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkColor3d</span><span class="p">()</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">vessel_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vessel_colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">vessel_colors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkNamedColors</span><span class="p">()</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">GetColor3d</span><span class="p">(</span><span class="n">vessel_colors</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">background_color</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">backcolors</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkColor3d</span><span class="p">()</span>
            <span class="n">backcolors</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">background_color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">background_color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">background_color</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">backcolors</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkNamedColors</span><span class="p">()</span>
            <span class="n">backcolors</span> <span class="o">=</span> <span class="n">backcolors</span><span class="o">.</span><span class="n">GetColor3d</span><span class="p">(</span><span class="n">background_color</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">surface_color</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">surf_color</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkColor3d</span><span class="p">()</span>
            <span class="n">surf_color</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">surface_color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">surface_color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">surface_color</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">surf_color</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkNamedColors</span><span class="p">()</span>
            <span class="n">surf_color</span> <span class="o">=</span> <span class="n">surf_color</span><span class="o">.</span><span class="n">GetColor3d</span><span class="p">(</span><span class="n">surface_color</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other_surface_color</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">other_surf_color</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkColor3d</span><span class="p">()</span>
            <span class="n">other_surf_color</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">other_surface_color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">other_surface_color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">other_surface_color</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other_surf_color</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkNamedColors</span><span class="p">()</span>
            <span class="n">other_surf_color</span> <span class="o">=</span> <span class="n">other_surf_color</span><span class="o">.</span><span class="n">GetColor3d</span><span class="p">(</span><span class="n">other_surface_color</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_segments</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">homogeneous</span><span class="p">:</span>
                <span class="n">data_subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">29</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data_subset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">center</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">data_subset</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_subset</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="n">data_subset</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">data_subset</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">12</span><span class="p">:</span><span class="mi">15</span><span class="p">])</span>
                <span class="n">vessel_length</span> <span class="o">=</span> <span class="n">data_subset</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
                <span class="n">cyl</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTubeFilter</span><span class="p">()</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkLineSource</span><span class="p">()</span>
                <span class="n">line</span><span class="o">.</span><span class="n">SetPoint1</span><span class="p">(</span><span class="n">data_subset</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">data_subset</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">data_subset</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">line</span><span class="o">.</span><span class="n">SetPoint2</span><span class="p">(</span><span class="n">data_subset</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span><span class="n">data_subset</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span><span class="n">data_subset</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
                <span class="n">cyl</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
                <span class="n">cyl</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
                <span class="n">cyl</span><span class="o">.</span><span class="n">SetNumberOfSides</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
                <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cyl</span><span class="p">)</span>
                <span class="n">mapper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
                <span class="n">actor</span>  <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
                <span class="n">mapper</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">cyl</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
                <span class="n">actor</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
                <span class="n">actor</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
                <span class="n">actors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">surface</span><span class="p">:</span>
                <span class="n">mapper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
                <span class="n">actor</span>  <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
                <span class="n">mapper</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">polydata</span><span class="p">)</span>
                <span class="n">actor</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
                <span class="n">actor</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="n">surf_color</span><span class="p">)</span>
                <span class="n">actor</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetOpacity</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
                <span class="n">actors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">other_surface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">subtracted_volumes</span><span class="p">:</span>
                    <span class="n">mapper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
                    <span class="n">actor</span>  <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
                    <span class="n">mapper</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">other_surface</span><span class="o">.</span><span class="n">polydata</span><span class="p">)</span>
                    <span class="n">actor</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
                    <span class="n">actor</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetColor</span><span class="p">(</span><span class="n">other_surf_color</span><span class="p">)</span>
                    <span class="n">actor</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetOpacity</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">actors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>
            <span class="n">renderer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderer</span><span class="p">()</span>
            <span class="n">renderer</span><span class="o">.</span><span class="n">SetBackground</span><span class="p">(</span><span class="n">backcolors</span><span class="p">)</span>

            <span class="n">render_window</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderWindow</span><span class="p">()</span>
            <span class="n">render_window</span><span class="o">.</span><span class="n">AddRenderer</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>
            <span class="n">render_window</span><span class="o">.</span><span class="n">SetWindowName</span><span class="p">(</span><span class="s1">&#39;SimVascular Vessel Network&#39;</span><span class="p">)</span>

            <span class="n">interactor</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderWindowInteractor</span><span class="p">()</span>
            <span class="n">interactor</span><span class="o">.</span><span class="n">SetRenderWindow</span><span class="p">(</span><span class="n">render_window</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">actor</span> <span class="ow">in</span> <span class="n">actors</span><span class="p">:</span>
                <span class="n">renderer</span><span class="o">.</span><span class="n">AddActor</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                <span class="n">render_window</span><span class="o">.</span><span class="n">Render</span><span class="p">()</span>
                <span class="n">w2if</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkWindowToImageFilter</span><span class="p">()</span>
                <span class="n">w2if</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">render_window</span><span class="p">)</span>
                <span class="n">w2if</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

                <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPNGWriter</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">()</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">tm_year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">tm_mon</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">tm_mday</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">tm_hour</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">tm_min</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">tm_sec</span><span class="p">)</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">w2if</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">show</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="n">render_window</span><span class="o">.</span><span class="n">Render</span><span class="p">()</span>
                <span class="n">interactor</span><span class="o">.</span><span class="n">Start</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">show</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">models</span></div>

<div class="viewcode-block" id="tree.save"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;network_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">tm_year</span><span class="p">)</span><span class="o">+</span>
                                               <span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">tm_mon</span><span class="p">)</span> <span class="o">+</span>
                                               <span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">tm_mday</span><span class="p">)</span><span class="o">+</span>
                                               <span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">tm_hour</span><span class="p">)</span><span class="o">+</span>
                                               <span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">tm_min</span><span class="p">)</span> <span class="o">+</span>
                                               <span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">tm_sec</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;/vessels.ccob&quot;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">file</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;/parameters.ccob&quot;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fraction</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">homogeneous</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">directed</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">convex</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span><span class="n">file</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;/boundary.ccob&quot;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="p">,</span><span class="n">file</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="tree.load"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;/vessels.ccob&quot;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;/parameters.ccob&quot;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fraction</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">homogeneous</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">directed</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">convex</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;/boundary.ccob&quot;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="tree.export"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">steady</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">apply_distal_resistance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cylinders</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">make</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">global_edge_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">splines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">splines_file_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">spline_sample_points</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cylinders</span><span class="p">:</span>
            <span class="n">pv_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
                <span class="n">pv_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">(</span><span class="n">var_inp</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()))</span>
            <span class="n">merge</span> <span class="o">=</span> <span class="n">pv_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pv_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">return</span> <span class="n">merge</span>
        <span class="n">interp_xyz</span><span class="p">,</span><span class="n">interp_r</span><span class="p">,</span><span class="n">interp_n</span><span class="p">,</span><span class="n">frames</span><span class="p">,</span><span class="n">branches</span><span class="p">,</span><span class="n">interp_xyzr</span> <span class="o">=</span> <span class="n">get_interpolated_sv_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="c1">#points,radii,normals    = sv_data(interp_xyzr,interp_r,radius_buffer=self.radius_buffer)</span>
        <span class="k">if</span> <span class="n">steady</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">22</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">22</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span><span class="p">,</span><span class="n">flow</span> <span class="o">=</span> <span class="n">wave</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">22</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#changed wave function</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">flow</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">apply_distal_resistance</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Pterm&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">22</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">make</span><span class="p">:</span>
            <span class="n">num_caps</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;edge_num&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">file_options</span><span class="p">(</span><span class="n">num_caps</span><span class="p">,</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span><span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="n">gui</span><span class="p">,</span><span class="n">distal_resistance</span><span class="o">=</span><span class="n">R</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">global_edge_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">set_mesh_options</span><span class="p">(</span><span class="n">global_edge_size</span><span class="o">=</span><span class="n">global_edge_size</span><span class="p">)</span>
            <span class="n">points</span><span class="p">,</span><span class="n">radii</span><span class="p">,</span><span class="n">normals</span>    <span class="o">=</span> <span class="n">sv_data</span><span class="p">(</span><span class="n">interp_xyzr</span><span class="p">,</span><span class="n">interp_r</span><span class="p">,</span><span class="n">radius_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_buffer</span><span class="p">)</span>
            <span class="n">build</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">radii</span><span class="p">,</span><span class="n">normals</span><span class="p">,</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">splines</span><span class="p">:</span>
            <span class="n">spline_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">splines_file_path</span><span class="o">+</span><span class="s1">&#39;b_splines.txt&#39;</span><span class="p">,</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">spline</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">interp_xyzr</span><span class="p">):</span>
                <span class="n">spline_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Vessel: </span><span class="si">{}</span><span class="s1">, Number of Points: </span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">spline_sample_points</span><span class="p">))</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">spline_sample_points</span><span class="p">)</span>
                <span class="n">spline_data</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">spline</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spline_sample_points</span><span class="p">):</span>
                    <span class="n">spline_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spline_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="n">spline_data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="n">spline_data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>
                <span class="n">spline_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">spline_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">interp_xyz</span><span class="p">,</span><span class="n">interp_r</span><span class="p">,</span><span class="n">interp_xyzr</span></div>

<div class="viewcode-block" id="tree.export_truncated"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.export_truncated">[docs]</a>    <span class="k">def</span> <span class="nf">export_truncated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">steady</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">indicies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">apply_distal_resistance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cylinders</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">make</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cylinders</span><span class="p">:</span>
            <span class="n">pv_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
                <span class="n">pv_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">(</span><span class="n">var_inp</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()))</span>
            <span class="n">merge</span> <span class="o">=</span> <span class="n">pv_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pv_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">return</span> <span class="n">merge</span>
        <span class="n">interp_xyz</span><span class="p">,</span><span class="n">interp_r</span><span class="p">,</span><span class="n">interp_n</span><span class="p">,</span><span class="n">frames</span><span class="p">,</span><span class="n">branches</span><span class="p">,</span><span class="n">interp_xyzr</span> <span class="o">=</span> <span class="n">get_truncated_interpolated_sv_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="n">indicies</span><span class="o">=</span><span class="n">indicies</span><span class="p">)</span>
        <span class="n">points</span><span class="p">,</span><span class="n">radii</span><span class="p">,</span><span class="n">normals</span>    <span class="o">=</span> <span class="n">sv_data</span><span class="p">(</span><span class="n">interp_xyzr</span><span class="p">,</span><span class="n">interp_r</span><span class="p">,</span><span class="n">radius_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">steady</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">22</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">22</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span><span class="p">,</span><span class="n">flow</span> <span class="o">=</span> <span class="n">wave</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">22</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">flow</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">apply_distal_resistance</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Pterm&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">22</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">make</span><span class="p">:</span>
            <span class="n">num_caps</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;edge_num&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">file_options</span><span class="p">(</span><span class="n">num_caps</span><span class="p">,</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span><span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="n">gui</span><span class="p">,</span><span class="n">distal_resistance</span><span class="o">=</span><span class="n">R</span><span class="p">)</span>
            <span class="n">build</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">radii</span><span class="p">,</span><span class="n">normals</span><span class="p">,</span><span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">interp_xyz</span><span class="p">,</span><span class="n">interp_r</span></div>

<div class="viewcode-block" id="tree.show_truncated"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.show_truncated">[docs]</a>    <span class="k">def</span> <span class="nf">show_truncated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">indicies</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">large</span><span class="p">,</span><span class="n">small</span> <span class="o">=</span> <span class="n">truncate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="n">indicies</span><span class="o">=</span><span class="n">indicies</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">plotter</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">large</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">+=</span> <span class="n">i</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Cylinder</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">12</span><span class="p">:</span><span class="mi">15</span><span class="p">],</span><span class="n">radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">21</span><span class="p">],</span><span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">20</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">combined</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">opacity</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">set_background</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plotter</span></div>

<div class="viewcode-block" id="tree.export_3d_solid"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.export_3d_solid">[docs]</a>    <span class="k">def</span> <span class="nf">export_3d_solid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">folder</span><span class="o">=</span><span class="s2">&quot;3d_tmp&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">folder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">folder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">polyline_from_points</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">()</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">pts</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">))</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">cell</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">scalars</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">poly</span>
        <span class="n">interp_xyz</span><span class="p">,</span><span class="n">interp_r</span><span class="p">,</span><span class="n">interp_xyzr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">make</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">surfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">t_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vessel_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">interp_xyz</span><span class="p">)):</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">t_list</span><span class="p">,</span><span class="n">interp_xyzr</span><span class="p">[</span><span class="n">vessel_id</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1">#_,r = splev(t_list,interp_r[vessel_id][0])</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">t_list</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
            <span class="n">points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
            <span class="n">polyline</span> <span class="o">=</span> <span class="n">polyline_from_points</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
            <span class="n">vessel</span> <span class="o">=</span> <span class="n">polyline</span><span class="o">.</span><span class="n">tube</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
            <span class="n">vessel_fix</span> <span class="o">=</span> <span class="n">pymeshfix</span><span class="o">.</span><span class="n">MeshFix</span><span class="p">(</span><span class="n">remesh_surface</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">triangulate</span><span class="p">(),</span><span class="n">hausd</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">vessel_fix</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">surfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel_fix</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
            <span class="c1">#tets.append(tetgen.TetGen(vessel_fix.mesh))</span>
        <span class="c1">#for i in tqdm(range(len(tets)),desc=&quot;Tetrahedralizing&quot;):</span>
        <span class="c1">#    tets[i].tetrahedralize(minratio=1.2)</span>
        <span class="c1">#surfs = []</span>
        <span class="c1">#for i in tqdm(range(len(tets)),desc=&quot;Extracting Surfaces&quot;):</span>
        <span class="c1">#    surfs.append(tets[i].grid.extract_surface().triangulate())</span>
        <span class="c1">#    surf_fix = pymeshfix.MeshFix(surfs[-1])</span>
        <span class="c1">#    surf_fix.repair(verbose=False)</span>
        <span class="c1">#    surfs[-1] = surf_fix.mesh</span>
        <span class="n">unioned</span> <span class="o">=</span> <span class="n">surfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">boolean_union</span><span class="p">(</span><span class="n">surfs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">unioned</span> <span class="o">=</span> <span class="n">unioned</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">surfs</span><span class="p">)),</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Unioning&quot;</span><span class="p">):</span>
            <span class="n">unioned</span> <span class="o">=</span> <span class="n">unioned</span><span class="o">.</span><span class="n">boolean_union</span><span class="p">(</span><span class="n">surfs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">unioned</span> <span class="o">=</span> <span class="n">unioned</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="n">unioned</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;unioned_solid.vtp&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;simvascular_python_script.py&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">export_3d_only</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;unioned_solid.vtp&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">vessels</span><span class="p">,</span><span class="n">unioned</span></div>

<div class="viewcode-block" id="tree.export_0d_simulation"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.export_0d_simulation">[docs]</a>    <span class="k">def</span> <span class="nf">export_0d_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">steady</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">folder</span><span class="o">=</span><span class="s2">&quot;0d_tmp&quot;</span><span class="p">,</span><span class="n">number_cardiac_cycles</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">number_time_pts_per_cycle</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="mf">1.06</span><span class="p">,</span><span class="n">viscosity</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span><span class="n">material</span><span class="o">=</span><span class="s2">&quot;olufsen&quot;</span><span class="p">,</span>
                      <span class="n">olufsen</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;k1&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span><span class="s1">&#39;k2&#39;</span><span class="p">:</span><span class="o">-</span><span class="mf">22.5267</span><span class="p">,</span><span class="s1">&#39;k3&#39;</span><span class="p">:</span><span class="mf">1.0e7</span><span class="p">,</span><span class="s1">&#39;material exponent&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span><span class="s1">&#39;material pressure&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">},</span>
                      <span class="n">linear</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;material ehr&#39;</span><span class="p">:</span><span class="mf">1e7</span><span class="p">,</span><span class="s1">&#39;material pressure&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">},</span><span class="n">path_to_0d_solver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">viscosity_model</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span><span class="n">vivo</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This script builds the 0D input file for running 0D simulation.</span>
<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        steady: bool, optional, [default=True]</span>
<span class="sd">        outdir: str, optional, [default=None]</span>
<span class="sd">        folder: str, optional, [default=&quot;tmp&quot;]</span>
<span class="sd">        number_cardiac_cycles: int, optional, [default=1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">folder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">folder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path_to_0d_solver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path_to_0d_solver</span> <span class="o">=</span> <span class="n">locate_0d_solver</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path_to_0d_solver</span> <span class="o">=</span> <span class="n">locate_0d_solver</span><span class="p">(</span><span class="n">windows_drive</span><span class="o">=</span><span class="n">path_to_0d_solver</span><span class="p">,</span><span class="n">linux_drive</span><span class="o">=</span><span class="n">path_to_0d_solver</span><span class="p">)</span>
        <span class="n">input_file</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;description&#39;</span><span class="p">:{</span><span class="s1">&#39;description of case&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="s1">&#39;analytical results&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
                      <span class="s1">&#39;boundary_conditions&#39;</span><span class="p">:[],</span>
                      <span class="s1">&#39;junctions&#39;</span><span class="p">:[],</span>
                      <span class="s1">&#39;simulation_parameters&#39;</span><span class="p">:{},</span>
                      <span class="s1">&#39;vessels&#39;</span><span class="p">:[]}</span>
        <span class="n">simulation_parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">simulation_parameters</span><span class="p">[</span><span class="s2">&quot;number_of_cardiac_cycles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">number_cardiac_cycles</span>
        <span class="n">simulation_parameters</span><span class="p">[</span><span class="s2">&quot;number_of_time_pts_per_cardiac_cycle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">number_time_pts_per_cycle</span>
        <span class="n">input_file</span><span class="p">[</span><span class="s1">&#39;simulation_parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simulation_parameters</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;vessel_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vessel</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;vessel_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;vessel_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;branch&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_seg0&quot;</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;zero_d_element_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;BloodVessel&quot;</span>
            <span class="k">if</span> <span class="n">material</span> <span class="o">==</span> <span class="s2">&quot;olufsen&quot;</span><span class="p">:</span>
                <span class="n">material_stiffness</span> <span class="o">=</span> <span class="n">olufsen</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">olufsen</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">21</span><span class="p">])</span><span class="o">+</span><span class="n">olufsen</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">material_stiffness</span> <span class="o">=</span> <span class="n">linear</span><span class="p">[</span><span class="s1">&#39;material ehr&#39;</span><span class="p">]</span>
            <span class="n">zero_d_element_values</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">viscosity_model</span> <span class="o">==</span> <span class="s1">&#39;constant&#39;</span><span class="p">:</span>
                <span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">viscosity_model</span> <span class="o">==</span> <span class="s1">&#39;modified viscosity law&#39;</span><span class="p">:</span>
                <span class="n">W</span>  <span class="o">=</span> <span class="mf">1.1</span>
                <span class="n">lam</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="n">D</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
                <span class="n">nu_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span>
                <span class="n">Hd</span> <span class="o">=</span> <span class="mf">0.45</span> <span class="c1">#discharge hematocrit (dimension-less)</span>
                <span class="n">C</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.8</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.075</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">11</span><span class="p">)</span><span class="o">*</span><span class="n">d</span><span class="o">**</span><span class="mi">12</span><span class="p">)))</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">11</span><span class="p">)</span><span class="o">*</span><span class="n">d</span><span class="o">**</span><span class="mi">12</span><span class="p">))</span>
                <span class="n">nu_vitro_45</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="mi">220</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.3</span><span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="mf">3.2</span><span class="o">-</span><span class="mf">2.44</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.06</span><span class="o">*</span><span class="n">d</span><span class="o">**</span><span class="mf">0.645</span><span class="p">)</span>
                <span class="n">nu_vivo_45</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="mi">6</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.085</span><span class="o">*</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="mf">3.2</span><span class="o">-</span><span class="mf">2.44</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.06</span><span class="o">*</span><span class="n">d</span><span class="o">**</span><span class="mf">0.645</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vivo</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">nu_45</span> <span class="o">=</span> <span class="n">nu_vivo_45</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nu_45</span> <span class="o">=</span> <span class="n">nu_vitro_45</span>
                <span class="n">nu_mod</span>   <span class="o">=</span>   <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">nu_45</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(((</span><span class="mi">1</span><span class="o">-</span><span class="n">Hd</span><span class="p">)</span><span class="o">**</span><span class="n">C</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="mf">0.45</span><span class="p">)</span><span class="o">**</span><span class="n">C</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="n">W</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">lam</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="n">W</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">lam</span><span class="p">))</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">nu_ref</span> <span class="o">-</span> <span class="n">nu_mod</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span> <span class="c1"># 1cm (units given in microns)</span>
                <span class="n">nu</span>  <span class="o">=</span> <span class="n">nu_mod</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> <span class="o">+</span> <span class="n">ref</span>
            <span class="n">zero_d_element_values</span><span class="p">[</span><span class="s2">&quot;R_poiseuille&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mi">8</span><span class="o">*</span><span class="n">nu</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">20</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span><span class="o">**</span><span class="mi">4</span>
            <span class="n">zero_d_element_values</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">material_stiffness</span><span class="p">)</span>
            <span class="n">zero_d_element_values</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span><span class="o">*</span><span class="n">density</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">zero_d_element_values</span><span class="p">[</span><span class="s2">&quot;stenosis_coefficient&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;zero_d_element_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_d_element_values</span>
            <span class="k">if</span> <span class="n">vessel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bc</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">bc</span><span class="p">[</span><span class="s1">&#39;bc_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;INFLOW&quot;</span>
                <span class="n">bc</span><span class="p">[</span><span class="s1">&#39;bc_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FLOW&quot;</span>
                <span class="n">bc_values</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">steady</span><span class="p">:</span>
                    <span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;Q&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">22</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">22</span><span class="p">]]</span>
                    <span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;inflow.flow&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">])):</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">  </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;Q&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="p">,</span><span class="n">flow</span> <span class="o">=</span> <span class="n">wave</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">22</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># changed wave function</span>
                    <span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;Q&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;Q&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;Q&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">simulation_parameters</span><span class="p">[</span><span class="s2">&quot;number_of_time_pts_per_cardiac_cycle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;Q&quot;</span><span class="p">])</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;inflow.flow&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">])):</span>
                            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">  </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;Q&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">bc</span><span class="p">[</span><span class="s1">&#39;bc_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_values</span>
                <span class="n">input_file</span><span class="p">[</span><span class="s1">&#39;boundary_conditions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;boundary_conditions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inlet&#39;</span><span class="p">:</span><span class="s2">&quot;INFLOW&quot;</span><span class="p">}</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">15</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">16</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">junction</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">junction</span><span class="p">[</span><span class="s1">&#39;inlet_vessels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="p">]</span>
                    <span class="n">junction</span><span class="p">[</span><span class="s1">&#39;junction_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;J&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                    <span class="n">junction</span><span class="p">[</span><span class="s1">&#39;junction_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NORMAL_JUNCTION&quot;</span>
                    <span class="n">junction</span><span class="p">[</span><span class="s1">&#39;outlet_vessels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">15</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">16</span><span class="p">])]</span>
                    <span class="n">input_file</span><span class="p">[</span><span class="s1">&#39;junctions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">junction</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">15</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">16</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bc</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">bc</span><span class="p">[</span><span class="s1">&#39;bc_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;OUT&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                <span class="n">bc</span><span class="p">[</span><span class="s1">&#39;bc_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;RESISTANCE&quot;</span>
                <span class="n">bc_values</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;Pd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;Pterm&quot;</span><span class="p">]</span>
                <span class="n">bc_values</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">bc</span><span class="p">[</span><span class="s1">&#39;bc_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_values</span>
                <span class="n">input_file</span><span class="p">[</span><span class="s1">&#39;boundary_conditions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;boundary_conditions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;outlet&#39;</span><span class="p">:</span><span class="s1">&#39;OUT&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="p">)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">junction</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">junction</span><span class="p">[</span><span class="s1">&#39;inlet_vessels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="p">]</span>
                <span class="n">junction</span><span class="p">[</span><span class="s1">&#39;junction_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;J&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                <span class="n">junction</span><span class="p">[</span><span class="s1">&#39;junction_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NORMAL_JUNCTION&quot;</span>
                <span class="n">junction</span><span class="p">[</span><span class="s1">&#39;outlet_vessels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">15</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,</span><span class="mi">16</span><span class="p">])]</span>
                <span class="n">input_file</span><span class="p">[</span><span class="s1">&#39;junctions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">junction</span><span class="p">)</span>
            <span class="n">input_file</span><span class="p">[</span><span class="s1">&#39;vessels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;solver_0d.in&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;plot_0d_results_to_3d.py&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">make_results</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;plot_0d_results_at_slices.py&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">view_plots</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;run.py&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">path_to_0d_solver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">solver_path</span> <span class="o">=</span> <span class="n">path_to_0d_solver</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">solver_path</span> <span class="o">=</span> <span class="n">path_to_0d_solver</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Solver location will have to be given manually&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current solver path is: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver_path</span><span class="p">))</span>
                <span class="n">solver_file</span> <span class="o">=</span> <span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;solver_0d.in&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">path_to_0d_solver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">solver_path</span> <span class="o">=</span> <span class="n">path_to_0d_solver</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">solver_path</span> <span class="o">=</span> <span class="n">path_to_0d_solver</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Solver location will have to be given manually&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current solver path is: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver_path</span><span class="p">))</span>
                <span class="n">solver_file</span> <span class="o">=</span> <span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;solver_0d.in&quot;</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">run_0d_script</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver_path</span><span class="p">,</span><span class="n">solver_file</span><span class="p">))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">geom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">geom</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">geom</span><span class="p">[:,</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">geom</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">20</span><span class="p">]</span>
        <span class="n">geom</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">21</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;geom.csv&quot;</span><span class="p">,</span><span class="n">geom</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="tree.export_1d_simulation"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.export_1d_simulation">[docs]</a>    <span class="k">def</span> <span class="nf">export_1d_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">steady</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">folder</span><span class="o">=</span><span class="s2">&quot;1d_tmp&quot;</span><span class="p">,</span><span class="n">number_cariac_cycles</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">num_points</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">interp_xyzr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">make</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Make Centerline Approximation Polydata</span>
        <span class="c1">#branches = get_branches(self.data)</span>
        <span class="c1">#centerline_ids = []</span>
        <span class="c1">#for id,branch in enumerate(branches):</span>
        <span class="c1">#    branch_ids = []</span>
        <span class="c1">#    for seg in branch</span>

        <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">folder</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">make_points</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Helper to make XYZ points&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">lines_from_points</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Given an array of points, make a line set&quot;&quot;&quot;</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">()</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">points</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
            <span class="n">cells</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
            <span class="n">cells</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">cells</span>
            <span class="k">return</span> <span class="n">poly</span>

        <span class="n">polys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">spline</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">interp_xyzr</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">num_points</span><span class="p">)</span>
            <span class="n">spline_data</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">spline</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">spline_data_normal</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">spline</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">make_points</span><span class="p">(</span><span class="n">spline_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">spline_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">spline_data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">normal</span> <span class="o">=</span> <span class="n">make_points</span><span class="p">(</span><span class="n">spline_data_normal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">spline_data_normal</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">spline_data_normal</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">normal</span> <span class="o">=</span> <span class="n">normal</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">poly_line</span> <span class="o">=</span> <span class="n">lines_from_points</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
            <span class="n">poly_line</span><span class="p">[</span><span class="s1">&#39;VesselId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">ind</span>
            <span class="n">poly_line</span><span class="p">[</span><span class="s1">&#39;MaximumInscribedSphereRadius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spline_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">poly_line</span><span class="p">[</span><span class="s1">&#39;CenterlineSectionArea&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">spline_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">poly_line</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span><span class="s1">&#39;CenterlineSectionNormal&#39;</span><span class="p">)</span>
            <span class="n">polys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly_line</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">)):</span>
            <span class="n">cent_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">n_points</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">cent_ids</span><span class="p">,</span><span class="s1">&#39;CenterlineId&#39;</span><span class="p">)</span>
            <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;CenterlineId&#39;</span><span class="p">][:,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">bifurcation_point_ids</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># polys ind index, polys jnd index, polys jnd point index</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">)):</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">ind</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">current</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">#if jnd == ind:</span>
                <span class="c1">#    continue</span>
                <span class="n">jnd</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">closest_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">current</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">closest_pt_id</span> <span class="o">=</span> <span class="n">polys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">find_closest_point</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">current</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">closest_point</span> <span class="o">=</span> <span class="n">polys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">closest_pt_id</span><span class="p">]</span>
                    <span class="n">closest_dist_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">current</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">closest_point</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">closest_dist_tmp</span> <span class="o">&lt;</span> <span class="n">closest_dist</span><span class="p">:</span>
                        <span class="n">jnd</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="n">closest_dist</span> <span class="o">=</span> <span class="n">closest_dist_tmp</span>
                <span class="n">closest_point_id</span> <span class="o">=</span> <span class="n">polys</span><span class="p">[</span><span class="n">jnd</span><span class="p">]</span><span class="o">.</span><span class="n">find_closest_point</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">current</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">closest_point</span>    <span class="o">=</span> <span class="n">polys</span><span class="p">[</span><span class="n">jnd</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">closest_point_id</span><span class="p">]</span>
                <span class="n">dist</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">current</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">closest_point</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">bifurcation_point_ids</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ind</span><span class="p">,</span><span class="n">jnd</span><span class="p">,</span><span class="n">closest_point_id</span><span class="p">,</span><span class="n">closest_point</span><span class="p">])</span>
                <span class="c1">#if dist &lt; polys[current].point_data[&#39;MaximumInscribedSphereRadius&#39;][0]:</span>
                <span class="n">polys</span><span class="p">[</span><span class="n">jnd</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;CenterlineId&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">closest_point_id</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="c1">#bifurcation_point_ids.append([ind,jnd,closest_point_id,closest_point])</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">jnd</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Determine Branch Temp Ids</span>
        <span class="n">branch_tmp_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">)):</span>
            <span class="n">tmp_split</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifurcation_point_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bif</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ind</span><span class="p">:</span>
                    <span class="n">tmp_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bif</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">tmp_split</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">tmp_split</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">tmp_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">branch_tmp_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp_split</span><span class="p">)):</span>
                <span class="n">branch_tmp_ids</span><span class="p">[</span><span class="n">tmp_split</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span><span class="n">tmp_split</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">branch_tmp_count</span>
                <span class="n">branch_tmp_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;BranchIdTmp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch_tmp_ids</span>

        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">)):</span>
            <span class="n">tmp_bif</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tmp_bif_pt</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifurcation_point_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">rad</span> <span class="o">=</span> <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;MaximumInscribedSphereRadius&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">pt</span>  <span class="o">=</span> <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
                    <span class="n">b</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">points</span> <span class="o">-</span> <span class="n">pt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">b_pt</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                    <span class="n">tmp_bif</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">tmp_bif_pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bif</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ind</span><span class="p">:</span>
                    <span class="n">rad</span> <span class="o">=</span> <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;MaximumInscribedSphereRadius&#39;</span><span class="p">][</span><span class="n">bif</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="n">pt</span>  <span class="o">=</span> <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="n">b</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">points</span> <span class="o">-</span> <span class="n">pt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">b_pt</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bif</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="n">tmp_bif</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">tmp_bif_pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_pt</span><span class="p">)</span>
            <span class="n">tmp_bif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tmp_bif</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">tmp_bif_pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tmp_bif_pt</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">bifurcation_id_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span>
            <span class="n">bifurcation_id_tmp</span><span class="p">[</span><span class="n">tmp_bif</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">bifurcation_id_tmp</span><span class="p">[</span><span class="n">tmp_bif_pt</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;BifurcationIdTmp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bifurcation_id_tmp</span>

        <span class="n">bif_id_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">)):</span>
            <span class="n">bif_id</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">jnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">n_points</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;BifurcationIdTmp&#39;</span><span class="p">][</span><span class="n">jnd</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">new</span><span class="p">:</span>
                    <span class="n">bif_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bif_id_count</span><span class="p">)</span>
                    <span class="c1">#bif_id_count_next = 1 + bif_id_count</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;BifurcationIdTmp&#39;</span><span class="p">][</span><span class="n">jnd</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new</span><span class="p">:</span>
                    <span class="n">bif_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bif_id_count</span><span class="p">)</span>
                    <span class="c1">#bif_id_count += 1</span>
                    <span class="c1">#new = True</span>
                <span class="k">elif</span> <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;BifurcationIdTmp&#39;</span><span class="p">][</span><span class="n">jnd</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new</span><span class="p">:</span>
                    <span class="n">bif_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">bif_id_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bif_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bif_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bif_id</span><span class="p">)</span>
            <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;BifurcationId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bif_id</span>

        <span class="n">branch_id_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">)):</span>
            <span class="n">branch_id</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">jnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">n_points</span><span class="p">):</span>
                <span class="n">new</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;BifurcationId&#39;</span><span class="p">][</span><span class="n">jnd</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">branch_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">branch_id_count</span><span class="p">)</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;BifurcationId&#39;</span><span class="p">][</span><span class="n">jnd</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new</span><span class="p">:</span>
                    <span class="n">branch_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">branch_id_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">branch_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">branch_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">branch_id</span><span class="p">)</span>
            <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;BranchId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch_id</span>

        <span class="c1"># Set Path Values for Branches and Bifurcations also obtain outlet branches</span>
        <span class="n">outlets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">)):</span>
            <span class="n">branch_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;BranchId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
            <span class="n">outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">branch_ids</span><span class="p">))</span>
            <span class="n">branch_ids</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">path_init</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;Path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_init</span>
            <span class="k">if</span> <span class="n">branch_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">branch_ids</span> <span class="o">=</span> <span class="n">branch_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">b_idx</span> <span class="ow">in</span> <span class="n">branch_ids</span><span class="p">:</span>
                <span class="n">poly_pt_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;BranchId&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">b_idx</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">poly_pt_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">poly_pt_ids</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;Path&#39;</span><span class="p">][</span><span class="n">poly_pt_ids</span><span class="p">]</span> <span class="o">=</span> <span class="n">poly_pt_path</span>
            <span class="n">bif_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;BifurcationId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
            <span class="n">bif_ids</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bif_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">bif_ids</span> <span class="o">=</span> <span class="n">bif_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">bif_idx</span> <span class="ow">in</span> <span class="n">bif_ids</span><span class="p">:</span>
                <span class="n">poly_pt_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;BifurcationId&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">bif_idx</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">poly_pt_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">poly_pt_ids</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;Path&#39;</span><span class="p">][</span><span class="n">poly_pt_ids</span><span class="p">]</span> <span class="o">=</span> <span class="n">poly_pt_path</span>

        <span class="c1"># Set Point Ids</span>
        <span class="n">Global_node_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">branch_starts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">)):</span>
            <span class="n">GlobalNodeId</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Global_node_count</span><span class="p">,</span><span class="n">Global_node_count</span><span class="o">+</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">n_points</span><span class="p">))</span>
            <span class="n">Global_node_count</span> <span class="o">=</span> <span class="n">GlobalNodeId</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">ind</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">):</span>
                <span class="n">branch_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Global_node_count</span><span class="p">)</span>
            <span class="n">GlobalNodeId</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">GlobalNodeId</span><span class="p">)</span>
            <span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s1">&#39;GlobalNodeId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GlobalNodeId</span>

        <span class="c1"># Merge and Connect Lines</span>
        <span class="n">centerlines_all</span> <span class="o">=</span> <span class="n">polys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">)):</span>
            <span class="n">closest_pt_id</span> <span class="o">=</span> <span class="n">centerlines_all</span><span class="o">.</span><span class="n">find_closest_point</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">closest_next_id</span> <span class="o">=</span> <span class="n">centerlines_all</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">centerlines_all</span> <span class="o">=</span> <span class="n">centerlines_all</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">polys</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
            <span class="n">new_line</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">closest_pt_id</span><span class="p">,</span><span class="n">closest_next_id</span><span class="p">]</span>
            <span class="n">centerlines_all</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">centerlines_all</span><span class="o">.</span><span class="n">lines</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_line</span><span class="p">)))</span>
        <span class="c1"># Connect lines among spline branches</span>
        <span class="c1">#for branch_global_node_id in branch_starts:</span>
        <span class="c1">#    pt_idx = np.argwhere(centerline_all.point_data[&#39;GlobalNodeId&#39;]==branch_global_node_id)</span>
        <span class="c1">#    remaining_points =</span>

        <span class="c1"># Generate 1D Solver Files</span>
        <span class="n">centerlines_all</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s1">&#39;centerlines.vtp&#39;</span><span class="p">)</span>
        <span class="c1">#param = ROM.parameters.Parameters()</span>
        <span class="c1">#param.output_directory = outdir</span>
        <span class="c1">#param</span>
        <span class="k">return</span> <span class="n">centerlines_all</span><span class="p">,</span><span class="n">polys</span></div>

<div class="viewcode-block" id="tree.export_centerlines"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.export_centerlines">[docs]</a>    <span class="k">def</span> <span class="nf">export_centerlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">folder</span><span class="o">=</span><span class="s2">&quot;centerlines_tmp&quot;</span><span class="p">,</span><span class="n">num_points</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">interp_xyzr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">make</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">folder</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">make_points</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Helper to make XYZ points&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">lines_from_points</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Given an array of points, make a line set&quot;&quot;&quot;</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">()</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">points</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
            <span class="n">cells</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
            <span class="n">cells</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">cells</span>
            <span class="k">return</span> <span class="n">poly</span>

        <span class="n">polys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">spline</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">interp_xyzr</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">num_points</span><span class="p">)</span>
            <span class="n">spline_data</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">spline</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">spline_data_normal</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">spline</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">make_points</span><span class="p">(</span><span class="n">spline_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">spline_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">spline_data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">normal</span> <span class="o">=</span> <span class="n">make_points</span><span class="p">(</span><span class="n">spline_data_normal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">spline_data_normal</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">spline_data_normal</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">normal</span> <span class="o">=</span> <span class="n">normal</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">poly_line</span> <span class="o">=</span> <span class="n">lines_from_points</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
            <span class="c1">#poly_line[&#39;VesselId&#39;] = np.ones(num_points,dtype=int)*ind</span>
            <span class="n">poly_line</span><span class="p">[</span><span class="s1">&#39;MaximumInscribedSphereRadius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spline_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="c1">#poly_line[&#39;CenterlineSectionArea&#39;] = np.pi*spline_data[3]**2</span>
            <span class="c1">#poly_line.point_data.set_array(normal,&#39;CenterlineSectionNormal&#39;)</span>
            <span class="n">polys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly_line</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">poly</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polys</span><span class="p">):</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;centerline_id_</span><span class="si">{}</span><span class="s2">.vtp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">polys</span></div>

<div class="viewcode-block" id="tree.collision_free"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.collision_free">[docs]</a>    <span class="k">def</span> <span class="nf">collision_free</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outside_vessels</span><span class="p">,</span><span class="n">radius_buffer</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">no_outside_collision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outside_vessels</span><span class="p">,</span><span class="n">radius_buffer</span><span class="o">=</span><span class="n">radius_buffer</span><span class="p">)</span></div>

<div class="viewcode-block" id="tree.export_gcode"><a class="viewcode-back" href="../../svcco.html#svcco.tree.tree.export_gcode">[docs]</a>    <span class="k">def</span> <span class="nf">export_gcode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">interp_xyz</span><span class="p">,</span><span class="n">interp_r</span><span class="p">,</span><span class="n">interp_n</span><span class="p">,</span><span class="n">frames</span><span class="p">,</span><span class="n">branches</span><span class="p">,</span><span class="n">interp_xyzr</span> <span class="o">=</span> <span class="n">get_interpolated_sv_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">points</span><span class="p">,</span><span class="n">radii</span><span class="p">,</span><span class="n">normals</span>    <span class="o">=</span> <span class="n">sv_data</span><span class="p">(</span><span class="n">interp_xyzr</span><span class="p">,</span><span class="n">interp_r</span><span class="p">,</span><span class="n">radius_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radius_buffer</span><span class="p">)</span>
        <span class="n">generate_gcode</span><span class="p">(</span><span class="n">points</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="forest"><a class="viewcode-back" href="../../svcco.html#svcco.tree.forest">[docs]</a><span class="k">class</span> <span class="nc">forest</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">number_of_networks</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">trees_per_network</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">start_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">directions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">root_lengths_high</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">root_lengths_low</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">convex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">compete</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The forest class defines some number of vascular networks which can grow</span>
<span class="sd">        within one given perfusion domain.</span>

<span class="sd">        Parameters</span>
<span class="sd">                   boundary: svcco.surface object</span>
<span class="sd">                             perfusion domain object defined by svcco.surface</span>
<span class="sd">                             which will serve as a boundary for all networks</span>
<span class="sd">                             built for this forest object</span>

<span class="sd">                             For more information see:</span>
<span class="sd">                             &gt;&gt;&gt;help(svcco.surface)</span>

<span class="sd">                   number_of_networks: int</span>
<span class="sd">                             integer specifying the number of networks to be</span>
<span class="sd">                             built for the given forest object (default=1)</span>

<span class="sd">                   trees_per_network: list of ints</span>
<span class="sd">                             list of integers specifying the number of</span>
<span class="sd">                             interpenetrating trees per network. By definition</span>
<span class="sd">                             len(trees_per_network) = number_of_networks</span>

<span class="sd">                   scale:</span>
<span class="sd">                   start_points:</span>
<span class="sd">                   directions:</span>
<span class="sd">                   root_lengths_high:</span>
<span class="sd">                   root_lengths_low:</span>
<span class="sd">                   convex:</span>
<span class="sd">                   compete:</span>

<span class="sd">        Methods:</span>
<span class="sd">                   set_roots</span>
<span class="sd">                   add</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span>    <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup</span>      <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span>    <span class="o">=</span> <span class="n">boundary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convex</span>      <span class="o">=</span> <span class="n">convex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compete</span>     <span class="o">=</span> <span class="n">compete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_networks</span> <span class="o">=</span> <span class="n">number_of_networks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span> <span class="o">=</span> <span class="n">trees_per_network</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_points</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
            <span class="n">start_points</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_networks</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">directions</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
            <span class="n">directions</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_networks</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">root_lengths_high</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
            <span class="n">root_lengths_high</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_networks</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">root_lengths_low</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
            <span class="n">root_lengths_low</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_networks</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">starting_points</span> <span class="o">=</span> <span class="n">start_points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_lengths_high</span> <span class="o">=</span> <span class="n">root_lengths_high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_lengths_low</span>  <span class="o">=</span> <span class="n">root_lengths_low</span>
        <span class="n">networks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_networks</span><span class="p">):</span>
            <span class="n">network</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">jdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">idx</span><span class="p">]):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">tree</span><span class="p">()</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">set_assumptions</span><span class="p">(</span><span class="n">convex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">convex</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">set_boundary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">jdx</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">clamped_root</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">network</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">networks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span>    <span class="o">=</span> <span class="n">networks</span>

<div class="viewcode-block" id="forest.set_roots"><a class="viewcode-back" href="../../svcco.html#svcco.tree.forest.set_roots">[docs]</a>    <span class="k">def</span> <span class="nf">set_roots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compete</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">volume</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_networks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Need to assign boundary!&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">networks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">connections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">backup</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_networks</span><span class="p">):</span>
            <span class="n">network</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;trees_per_network must be list of ints&quot;</span><span class="o">+</span>
                      <span class="s2">&quot; with length equal to number_of_networks&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">jdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">idx</span><span class="p">]):</span>
                <span class="c1">#tmp = tree()</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">jdx</span><span class="p">]</span>
                <span class="c1">#tmp.set_assumptions(convex=self.convex)</span>
                <span class="c1">#if self.directions[idx][jdx] is not None:</span>
                <span class="c1">#    tmp.clamped_root = True</span>
                <span class="c1">#tmp.set_boundary(self.boundary)</span>
                <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Qterm&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">jdx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">collisions</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">collisions</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>
                <span class="k">while</span> <span class="nb">any</span><span class="p">(</span><span class="n">collisions</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tmp</span><span class="o">.</span><span class="n">set_root</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">starting_points</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">jdx</span><span class="p">],</span>
                                     <span class="n">direction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">jdx</span><span class="p">],</span>
                                     <span class="n">limit_high</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_lengths_high</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">jdx</span><span class="p">],</span>
                                     <span class="n">limit_low</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_lengths_low</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">jdx</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not implemented yet!&quot;</span><span class="p">)</span>
                    <span class="n">collisions</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">net</span> <span class="ow">in</span> <span class="n">networks</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">net</span><span class="p">:</span>
                            <span class="n">collisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">collision_free</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">collisions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">repeat</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="n">repeat</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">network</span><span class="p">:</span>
                        <span class="n">collisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">collision_free</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="n">collisions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">repeat</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="c1">#print(collisions)</span>
                <span class="n">network</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">networks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
            <span class="n">connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">backup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span>    <span class="o">=</span> <span class="n">networks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="n">connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup</span>      <span class="o">=</span> <span class="n">backup</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">volume</span></div>

<div class="viewcode-block" id="forest.add"><a class="viewcode-back" href="../../svcco.html#svcco.tree.forest.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">number_of_branches</span><span class="p">,</span><span class="n">network_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">radius_buffer</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compete</span><span class="p">:</span>
            <span class="n">network_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">network_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">exit_number</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">active_networks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">network</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">:</span>
                <span class="n">exit_number</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">network</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;edge_num&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">number_of_branches</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exit_number</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">active_networks</span> <span class="o">=</span> <span class="p">[</span><span class="n">network_id</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_networks</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">active_networks</span><span class="p">:</span>
                    <span class="n">exit_number</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">nid</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;edge_num&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">number_of_branches</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exit_number</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">nid</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;edge_num&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">AN</span> <span class="ow">in</span> <span class="n">active_networks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ATr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">AN</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">AN</span><span class="p">][</span><span class="n">ATr</span><span class="p">]</span><span class="o">.</span><span class="n">rng_points</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">pick</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">40</span><span class="o">*</span><span class="n">number_of_branches</span><span class="p">,</span><span class="n">homogeneous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">AN</span><span class="p">][</span><span class="n">ATr</span><span class="p">]</span><span class="o">.</span><span class="n">rng_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">AN</span><span class="p">][</span><span class="n">ATr</span><span class="p">]</span><span class="o">.</span><span class="n">rng_points</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compete</span><span class="p">:</span>
                    <span class="c1"># new</span>
                    <span class="c1">#self.networks[AN][ATr].rng_points,_ = self.boundary.pick(size=len(self.boundary.tet_verts),homogeneous=True,replacement=False)</span>
                    <span class="c1">#self.networks[AN][ATr].rng_points = self.networks[AN][ATr].rng_points.tolist()</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">AN</span><span class="p">][</span><span class="n">ATr</span><span class="p">]</span><span class="o">.</span><span class="n">rng_points</span><span class="p">))):</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">AN</span><span class="p">][</span><span class="n">ATr</span><span class="p">]</span><span class="o">.</span><span class="n">rng_points</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">exact</span><span class="p">:</span>
                            <span class="n">other_vessels</span><span class="p">,</span><span class="n">distances</span> <span class="o">=</span> <span class="n">close_exact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">AN</span><span class="p">][</span><span class="n">ATr</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">other_vessels</span><span class="p">,</span><span class="n">distances</span> <span class="o">=</span> <span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">AN</span><span class="p">][</span><span class="n">ATr</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span>
                        <span class="n">minimum_distance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
                        <span class="c1">#if minimum_distance &lt; 4*forest.networks[nid][njd].data[other_vessels[0],21]:</span>
                        <span class="c1">#    continue</span>
                        <span class="n">retry</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">active_networks</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">jdx</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">idx</span><span class="p">])):</span>
                                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">AN</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="n">exact</span><span class="p">:</span>
                                    <span class="n">other_vessels</span><span class="p">,</span><span class="n">distances</span> <span class="o">=</span> <span class="n">close_exact</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">jdx</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">other_vessels</span><span class="p">,</span><span class="n">distances</span> <span class="o">=</span> <span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">jdx</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minimum_distance</span><span class="p">:</span>
                                    <span class="n">retry</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">break</span>
                            <span class="k">if</span> <span class="n">retry</span><span class="p">:</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="n">retry</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">AN</span><span class="p">][</span><span class="n">ATr</span><span class="p">]</span><span class="o">.</span><span class="n">rng_points</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">pt</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="c1">#new</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compete</span><span class="p">:</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_networks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">active_networks</span><span class="p">:</span>
                    <span class="n">number_of_trees</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">nid</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">njd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_trees</span><span class="p">):</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">threshold</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">while</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                            <span class="n">vessel</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">sub_division_map</span><span class="p">,</span><span class="n">sub_division_index</span><span class="p">,</span><span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">nid</span><span class="p">][</span><span class="n">njd</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">isforest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">radius_buffer</span><span class="o">=</span><span class="n">radius_buffer</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>
                            <span class="n">new_vessels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">vessel</span><span class="p">,:],</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,:],</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]))</span>
                            <span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">for</span> <span class="n">nikd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">)):</span>
                                <span class="k">if</span> <span class="n">nikd</span> <span class="o">==</span> <span class="n">nid</span><span class="p">:</span>
                                    <span class="n">check_trees</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">nikd</span><span class="p">])))</span>
                                    <span class="n">check_trees</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">njd</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">check_trees</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">nikd</span><span class="p">])))</span>
                                <span class="k">for</span> <span class="n">njkd</span> <span class="ow">in</span> <span class="n">check_trees</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">nikd</span><span class="p">][</span><span class="n">njkd</span><span class="p">]</span><span class="o">.</span><span class="n">collision_free</span><span class="p">(</span><span class="n">new_vessels</span><span class="p">,</span><span class="n">radius_buffer</span><span class="o">=</span><span class="n">radius_buffer</span><span class="p">):</span>
                                        <span class="n">repeat</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">break</span>
                                <span class="k">if</span> <span class="n">repeat</span><span class="p">:</span>
                                    <span class="k">break</span>
                            <span class="k">if</span> <span class="n">repeat</span><span class="p">:</span>
                                <span class="c1">#p = self.show()</span>
                                <span class="c1">#p.show()</span>
                                <span class="c1">#print(&quot;\n\ncollision\n\n&quot;)</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">nid</span><span class="p">][</span><span class="n">njd</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">nid</span><span class="p">][</span><span class="n">njd</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;edge_num&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">nid</span><span class="p">][</span><span class="n">njd</span><span class="p">]</span><span class="o">.</span><span class="n">sub_division_map</span> <span class="o">=</span> <span class="n">sub_division_map</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">nid</span><span class="p">][</span><span class="n">njd</span><span class="p">]</span><span class="o">.</span><span class="n">sub_division_index</span> <span class="o">=</span> <span class="n">sub_division_index</span>
                    <span class="c1">#print(self.networks[nid][0].parameters[&#39;edge_num&#39;])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">nid</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;edge_num&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">exit_number</span><span class="p">[</span><span class="n">nid</span><span class="p">]:</span>
                        <span class="n">active_networks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">number_of_branches</span><span class="p">),</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Adding branches&quot;</span><span class="p">):</span>
                <span class="n">compete_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">network_ids</span><span class="o">=</span><span class="n">network_id</span><span class="p">,</span><span class="n">radius_buffer</span><span class="o">=</span><span class="n">radius_buffer</span><span class="p">)</span></div>

<div class="viewcode-block" id="forest.show"><a class="viewcode-back" href="../../svcco.html#svcco.tree.forest.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">final</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">merged_trees</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">background</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span><span class="n">off_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">merged_trees</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
            <span class="n">plotter</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
            <span class="n">merged_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_networks</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                    <span class="n">merged_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">cylinders</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                    <span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">merged_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">plotter</span><span class="p">,</span><span class="n">merged_list</span>
        <span class="n">model_networks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">net_id</span><span class="p">,</span><span class="n">network</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">):</span>
            <span class="n">model_trees</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tree_id</span><span class="p">,</span><span class="n">network_tree</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">network</span><span class="p">):</span>
                <span class="n">model</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">network_tree</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;edge_num&#39;</span><span class="p">]):</span>
                    <span class="c1">#if network_tree.data[edge,15]==-1 and network_tree.data[edge,16]==-1 and edge != 0:</span>
                    <span class="c1">#    dis_point = (network_tree.data[edge,0:3] + network_tree.data[edge,3:6])/2</span>
                    <span class="c1">#    vessel_length = network_tree.data[edge,20]/2</span>
                    <span class="c1">#else:</span>
                    <span class="n">dis_point</span> <span class="o">=</span> <span class="n">network_tree</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
                    <span class="n">vessel_length</span> <span class="o">=</span> <span class="n">network_tree</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
                    <span class="n">center</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">network_tree</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">dis_point</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">radius</span> <span class="o">=</span> <span class="n">network_tree</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">network_tree</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">edge</span><span class="p">,</span><span class="mi">12</span><span class="p">:</span><span class="mi">15</span><span class="p">])</span>
                    <span class="c1">#vessel_length = network_tree.data[edge,20]</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pv</span><span class="o">.</span><span class="n">Cylinder</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="n">vessel_length</span><span class="p">,</span>
                                             <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span>
                                             <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">net_id</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">net_id</span><span class="p">][</span><span class="n">tree_id</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">net_id</span><span class="p">][</span><span class="n">tree_id</span><span class="p">][</span><span class="n">edge</span><span class="p">,:]</span>
                        <span class="n">center</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">term</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">term</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">radius</span> <span class="o">=</span> <span class="n">term</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span>
                        <span class="n">direction</span> <span class="o">=</span> <span class="n">term</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span>
                        <span class="n">vessel_length</span> <span class="o">=</span> <span class="n">term</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pv</span><span class="o">.</span><span class="n">Cylinder</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="n">vessel_length</span><span class="p">,</span>
                                                 <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span>
                                                 <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>
                    <span class="c1">#for edge in range(len(self.connections[net_id][0])):</span>
                    <span class="c1">#    term = network_tree.data[self.assignments[net_id][tree_id][edge],:]</span>
                    <span class="c1">#    conn = self.connections[net_id][0][edge]</span>
                    <span class="c1">#    center = tuple((term[3:6] + conn)/2)</span>
                    <span class="c1">#    radius = term[21]</span>
                    <span class="c1">#    direction = tuple(conn-term[3:6])</span>
                    <span class="c1">#    vessel_length = np.linalg.norm(conn-term[3:6])</span>
                    <span class="c1">#    model.append(pv.Cylinder(radius=radius,height=vessel_length,</span>
                    <span class="c1">#                             center=center,direction=direction,</span>
                    <span class="c1">#                             resolution=resolution))</span>
                <span class="n">model_trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">model_networks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_trees</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        model_connections = []</span>
<span class="sd">        for connections in conn:</span>
<span class="sd">            if connections is None:</span>
<span class="sd">                continue</span>
<span class="sd">            else:</span>
<span class="sd">                for c_idx in range(connections.shape[0]):</span>
<span class="sd">                    center = tuple((connections[c_idx,0:3] + connections[c_idx,3:6])/2)</span>
<span class="sd">                    radius = connections[c_idx,21]</span>
<span class="sd">                    direction = tuple((connections[c_idx,3:6] - connections[c_idx,0:3])/connections[c_idx,20])</span>
<span class="sd">                    vessel_length = connections[c_idx,20]</span>
<span class="sd">                    model_conn.append(pv.Cylinder(radius=radius,height=vessel_length,</span>
<span class="sd">                                                  center=center,direction=direction,</span>
<span class="sd">                                                  resolution=resolution))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Plotter</span><span class="p">(</span><span class="n">off_screen</span><span class="o">=</span><span class="n">off_screen</span><span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
            <span class="n">plot</span><span class="o">.</span><span class="n">set_background</span><span class="p">(</span><span class="n">background</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">model_idx</span><span class="p">,</span><span class="n">model_network</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_networks</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">color_idx</span><span class="p">,</span> <span class="n">model_tree</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_network</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">model_tree</span><span class="p">:</span>
                        <span class="n">plot</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">colors</span><span class="p">[</span><span class="n">color_idx</span><span class="p">])</span>
            <span class="c1">#for c_model in model_conn:</span>
            <span class="c1">#    plot.add_mesh(c_model,&#39;r&#39;)</span>
                <span class="c1">#if i == 0:</span>
                <span class="c1">#    plot.add_mesh(model[i],&#39;r&#39;)</span>
                <span class="c1">#else:</span>
                <span class="c1">#    plot.add_mesh(model[i],&#39;b&#39;)</span>
            <span class="c1">#path = plot.generate_orbital_path(n_points=100,viewup=(1,1,1))</span>
            <span class="c1">#plot.show(auto_close=False)</span>
            <span class="c1">#plot.open_gif(&#39;cco_gamma.gif&#39;)</span>
            <span class="c1">#plot.orbit_on_path(path,write_frames=True)</span>
            <span class="c1">#plot.close()</span>
            <span class="k">return</span> <span class="n">plot</span></div>

<div class="viewcode-block" id="forest.connect"><a class="viewcode-back" href="../../svcco.html#svcco.tree.forest.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">network_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">curve_sample_size_min</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">curve_sample_size_max</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">curve_degree</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forest_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forest_copy</span><span class="o">.</span><span class="n">connections</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">forest_copy</span><span class="o">.</span><span class="n">assignments</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forest_copy</span><span class="p">,</span><span class="n">network_id</span><span class="o">=</span><span class="n">network_id</span><span class="p">,</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>
        <span class="c1">#self.forest_copy.connections,self.forest_copy.connected_forest,self.splines = smooth(self.forest_copy,curve_sample_size_min=curve_sample_size_min,curve_sample_size_max=curve_sample_size_max,curve_degree=curve_degree)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forest_copy</span><span class="o">.</span><span class="n">connections</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forest_copy</span><span class="p">)</span></div>

<div class="viewcode-block" id="forest.assign"><a class="viewcode-back" href="../../svcco.html#svcco.tree.forest.assign">[docs]</a>    <span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">assignments</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="forest.rotate"><a class="viewcode-back" href="../../svcco.html#svcco.tree.forest.rotate">[docs]</a>    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">forest_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">forest_copy</span><span class="o">.</span><span class="n">assign</span><span class="p">()</span>
        <span class="n">comb</span><span class="p">,</span><span class="n">pts</span> <span class="o">=</span> <span class="n">rotate_terminals</span><span class="p">(</span><span class="n">forest_copy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forest_copy</span> <span class="o">=</span> <span class="n">forest_copy</span>
        <span class="k">return</span> <span class="n">comb</span><span class="p">,</span><span class="n">pts</span></div>

<div class="viewcode-block" id="forest.copy"><a class="viewcode-back" href="../../svcco.html#svcco.tree.forest.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">forest_copy</span> <span class="o">=</span> <span class="n">forest</span><span class="p">(</span><span class="n">boundary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="p">,</span><span class="n">number_of_networks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_networks</span><span class="p">,</span>
                             <span class="n">trees_per_network</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">convex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">convex</span><span class="p">,</span>
                             <span class="n">compete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compete</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ndx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_networks</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">tdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">ndx</span><span class="p">]):</span>
                <span class="n">forest_copy</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">ndx</span><span class="p">][</span><span class="n">tdx</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">ndx</span><span class="p">][</span><span class="n">tdx</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">forest_copy</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">ndx</span><span class="p">][</span><span class="n">tdx</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">ndx</span><span class="p">][</span><span class="n">tdx</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
                <span class="n">forest_copy</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">ndx</span><span class="p">][</span><span class="n">tdx</span><span class="p">]</span><span class="o">.</span><span class="n">sub_division_map</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">ndx</span><span class="p">][</span><span class="n">tdx</span><span class="p">]</span><span class="o">.</span><span class="n">sub_division_map</span><span class="p">)</span>
                <span class="n">forest_copy</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">ndx</span><span class="p">][</span><span class="n">tdx</span><span class="p">]</span><span class="o">.</span><span class="n">sub_division_index</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">ndx</span><span class="p">][</span><span class="n">tdx</span><span class="p">]</span><span class="o">.</span><span class="n">sub_division_index</span><span class="p">)</span>
        <span class="n">forest_copy</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">)</span>
        <span class="n">forest_copy</span><span class="o">.</span><span class="n">assignments</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">forest_copy</span></div>

<div class="viewcode-block" id="forest.export_solid"><a class="viewcode-back" href="../../svcco.html#svcco.tree.forest.export_solid">[docs]</a>    <span class="k">def</span> <span class="nf">export_solid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">folder</span><span class="o">=</span><span class="s2">&quot;3d_tmp&quot;</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">variable_thickness</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shell_thickness</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">folder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">folder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">polyline_from_points</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">()</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">pts</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">))</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">cell</span>
            <span class="n">poly</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span> <span class="c1">#r/min(r)</span>
            <span class="k">return</span> <span class="n">poly</span>
        <span class="n">final_points</span><span class="p">,</span><span class="n">final_radii</span><span class="p">,</span><span class="n">final_normals</span><span class="p">,</span><span class="n">CONNECTED_COPY</span><span class="p">,</span><span class="n">ALL_INTERP_XYZ</span><span class="p">,</span><span class="n">ALL_INTERP_RADII</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
        <span class="n">ALL_vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ALL_tets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ALL_surfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ALL_vessel_shells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ALL_tet_shells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ALL_surf_shells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">t_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">net_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">final_points</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">net_id</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">interp_xyz</span> <span class="o">=</span> <span class="n">ALL_INTERP_XYZ</span><span class="p">[</span><span class="n">net_id</span><span class="p">][</span><span class="n">tree</span><span class="p">]</span>
                <span class="n">interp_r</span> <span class="o">=</span> <span class="n">ALL_INTERP_RADII</span><span class="p">[</span><span class="n">net_id</span><span class="p">][</span><span class="n">tree</span><span class="p">]</span>
                <span class="n">vessels</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">tets</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">surfs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">shell</span><span class="p">:</span>
                    <span class="n">vessel_shells</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">tet_shells</span>    <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">surf_shells</span>   <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">vessel_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ALL_POINTS</span><span class="p">[</span><span class="n">net_id</span><span class="p">][</span><span class="n">tree</span><span class="p">])):</span>
                    <span class="c1">#x,y,z = splev(t_list,interp_xyz[vessel_id][0])</span>
                    <span class="c1">#_,r = splev(t_list,interp_r[vessel_id][0])</span>
                    <span class="c1">#points = np.zeros((len(t_list),3))</span>
                    <span class="c1">#points[:,0] = x</span>
                    <span class="c1">#points[:,1] = y</span>
                    <span class="c1">#points[:,2] = z</span>
                    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ALL_POINTS</span><span class="p">[</span><span class="n">net_id</span><span class="p">][</span><span class="n">tree</span><span class="p">][</span><span class="n">vessel_id</span><span class="p">])</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ALL_RADII</span><span class="p">[</span><span class="n">net_id</span><span class="p">][</span><span class="n">tree</span><span class="p">][</span><span class="n">vessel_id</span><span class="p">])</span>
                    <span class="c1">#print(&quot;Points: {}&quot;.format(points))</span>
                    <span class="c1">#print(&quot;Radii:  {}&quot;.format(r))</span>
                    <span class="k">if</span> <span class="n">shell</span><span class="p">:</span>
                        <span class="n">polyline_shell</span> <span class="o">=</span> <span class="n">polyline_from_points</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">r</span><span class="o">+</span><span class="n">shell_thickness</span><span class="p">)</span>
                        <span class="n">vessel_shell</span>   <span class="o">=</span> <span class="n">polyline_shell</span><span class="o">.</span><span class="n">tube</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">shell_thickness</span><span class="p">),</span><span class="n">scalars</span><span class="o">=</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span><span class="n">radius_factor</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">shell_thickness</span><span class="p">)</span><span class="o">/</span><span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">shell_thickness</span><span class="p">))</span><span class="o">.</span><span class="n">triangulate</span><span class="p">()</span>
                        <span class="c1">#vessel_shell   = remesh_surface(vessel_shell,auto=False,hausd=min(r+shell_thickness)/10,verbosity=0)</span>
                        <span class="n">vessel_shells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel_shell</span><span class="p">)</span>
                        <span class="n">tet_shells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tetgen</span><span class="o">.</span><span class="n">TetGen</span><span class="p">(</span><span class="n">vessel_shell</span><span class="p">))</span>
                    <span class="n">polyline</span> <span class="o">=</span> <span class="n">polyline_from_points</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
                    <span class="n">vessel</span> <span class="o">=</span> <span class="n">polyline</span><span class="o">.</span><span class="n">tube</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">),</span><span class="n">scalars</span><span class="o">=</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span><span class="n">radius_factor</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="o">.</span><span class="n">triangulate</span><span class="p">()</span>
                    <span class="c1">#vessel = remesh_surface(vessel,auto=False,hausd=min(r)/10,verbosity=0)</span>
                    <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                    <span class="n">P</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">vessel</span><span class="p">,</span><span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">opacity</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
                    <span class="n">P</span><span class="o">.</span><span class="n">add_points</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">render_points_as_spheres</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">point_size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                    <span class="n">tets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tetgen</span><span class="o">.</span><span class="n">TetGen</span><span class="p">(</span><span class="n">vessel</span><span class="p">))</span>
                <span class="n">desc1</span> <span class="o">=</span> <span class="s1">&#39;Tetrahedralizing&#39;</span>
                <span class="n">desc1</span> <span class="o">=</span> <span class="n">desc1</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">40</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">desc1</span><span class="p">))</span>

                <span class="c1"># Disable</span>
                <span class="k">def</span> <span class="nf">blockPrint</span><span class="p">():</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

                <span class="c1"># Restore</span>
                <span class="k">def</span> <span class="nf">enablePrint</span><span class="p">():</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span>

                <span class="c1">#@timeout(60)</span>
                <span class="k">def</span> <span class="nf">tetrahedralize</span><span class="p">(</span><span class="n">tet</span><span class="p">):</span>
                    <span class="n">tet</span><span class="o">.</span><span class="n">tetrahedralize</span><span class="p">(</span><span class="n">minratio</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">tet</span>

                <span class="n">tet_success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">tet_fail_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">tet_fail_shell_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tets</span><span class="p">)),</span><span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bar_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{l_bar}{bar:50}{r_bar}{bar:-10b}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="n">desc1</span><span class="p">):</span>
                    <span class="n">blockPrint</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tetrahedralize</span><span class="p">(</span><span class="n">tets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">fixed_mesh</span> <span class="o">=</span> <span class="n">pymeshfix</span><span class="o">.</span><span class="n">MeshFix</span><span class="p">(</span><span class="n">vessels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                            <span class="n">fixed_mesh</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">tets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tetgen</span><span class="o">.</span><span class="n">TetGen</span><span class="p">(</span><span class="n">fixed_mesh</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
                            <span class="n">tets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tetrahedralize</span><span class="p">(</span><span class="n">tets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">tet_success</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">tet_fail_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">enablePrint</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">shell</span><span class="p">:</span>
                        <span class="n">blockPrint</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">tet_shells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tetrahedralize</span><span class="p">(</span><span class="n">tet_shells</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">fixed_mesh</span> <span class="o">=</span> <span class="n">pymeshfix</span><span class="o">.</span><span class="n">MeshFix</span><span class="p">(</span><span class="n">vessel_shells</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                <span class="n">fixed_mesh</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="n">tet_shells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tetgen</span><span class="o">.</span><span class="n">TetGen</span><span class="p">(</span><span class="n">fixed_mesh</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
                                <span class="n">tet_shells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tetrahedralize</span><span class="p">(</span><span class="n">tet_shells</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">tet_success</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">tet_fail_shell_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">enablePrint</span><span class="p">()</span>
                <span class="n">desc2</span> <span class="o">=</span> <span class="s1">&#39;Extracting Surfaces&#39;</span>
                <span class="n">desc2</span> <span class="o">=</span> <span class="n">desc2</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">40</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">desc2</span><span class="p">))</span>
                <span class="n">surf_success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">surf_fail_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">surf_fail_shell_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tets</span><span class="p">)),</span><span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bar_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{l_bar}{bar:50}{r_bar}{bar:-10b}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="n">desc2</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">surf_fix</span>  <span class="o">=</span> <span class="n">pymeshfix</span><span class="o">.</span><span class="n">MeshFix</span><span class="p">(</span><span class="n">tets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">extract_surface</span><span class="p">()</span><span class="o">.</span><span class="n">triangulate</span><span class="p">())</span>
                        <span class="n">surf_fix</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">surfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">surf_fix</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">surf_success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">surf_fail_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">shell</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">surf_shell_fix</span> <span class="o">=</span> <span class="n">pymeshfix</span><span class="o">.</span><span class="n">MeshFix</span><span class="p">(</span><span class="n">tet_shells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">extract_surface</span><span class="p">()</span><span class="o">.</span><span class="n">triangulate</span><span class="p">())</span>
                            <span class="n">surf_shell_fix</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">surf_shells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">surf_shell_fix</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">surf_success</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">surf_fail_shell_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">ALL_vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessels</span><span class="p">)</span>
                <span class="n">ALL_tets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tets</span><span class="p">)</span>
                <span class="n">ALL_surfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">surfs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shell</span><span class="p">:</span>
                    <span class="n">ALL_vessel_shells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel_shells</span><span class="p">)</span>
                    <span class="n">ALL_tet_shells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tet_shells</span><span class="p">)</span>
                    <span class="n">ALL_surf_shells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">surf_shells</span><span class="p">)</span>
                <span class="n">unioned</span> <span class="o">=</span> <span class="n">surfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">boolean_union</span><span class="p">(</span><span class="n">surfs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">unioned</span> <span class="o">=</span> <span class="n">unioned</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">shell</span><span class="p">:</span>
                    <span class="n">unioned_shell</span> <span class="o">=</span> <span class="n">surf_shells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">boolean_union</span><span class="p">(</span><span class="n">surf_shells</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">unioned_shell</span> <span class="o">=</span> <span class="n">unioned_shell</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
                    <span class="n">last_unioned_shell</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">unioned_shell</span><span class="p">)</span>
                <span class="n">desc3</span> <span class="o">=</span> <span class="s1">&#39;Unioning&#39;</span>
                <span class="n">desc3</span> <span class="o">=</span> <span class="n">desc3</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">40</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">desc3</span><span class="p">))</span>
                <span class="n">union_success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">union_fail_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">union_fail_shell_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">last_unioned</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">unioned</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">surfs</span><span class="p">)),</span><span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bar_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{l_bar}{bar:50}{r_bar}{bar:-10b}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="n">desc3</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">unioned</span> <span class="o">=</span> <span class="n">unioned</span><span class="o">.</span><span class="n">boolean_union</span><span class="p">(</span><span class="n">surfs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">unioned</span> <span class="o">=</span> <span class="n">unioned</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
                        <span class="n">last_unioned</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">unioned</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">union_success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">union_fail_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">unioned</span> <span class="o">=</span> <span class="n">last_unioned</span>
                    <span class="k">if</span> <span class="n">shell</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">unioned_shell</span> <span class="o">=</span> <span class="n">unioned_shell</span><span class="o">.</span><span class="n">boolean_union</span><span class="p">(</span><span class="n">surf_shells</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                            <span class="n">unioned_shell</span> <span class="o">=</span> <span class="n">unioned_shell</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
                            <span class="n">last_unioned_shell</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">unioned_shell</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">union_success</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">union_fail_shell_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">unioned_shell</span> <span class="o">=</span> <span class="n">last_unioned_shell</span>
                <span class="k">if</span> <span class="n">union_success</span><span class="p">:</span>
                    <span class="n">unioned</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;unioned_solid_network_</span><span class="si">{}</span><span class="s2">_tree_</span><span class="si">{}</span><span class="s2">.vtp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">net_id</span><span class="p">,</span><span class="n">tree</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">shell</span><span class="p">:</span>
                        <span class="n">unioned_shell</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;unioned_solid_network_shell_</span><span class="si">{}</span><span class="s2">_tree_</span><span class="si">{}</span><span class="s2">.vtp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">net_id</span><span class="p">,</span><span class="n">tree</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">unioned</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;partial_unioned_solid_network_</span><span class="si">{}</span><span class="s2">_tree_</span><span class="si">{}</span><span class="s2">.vtp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">net_id</span><span class="p">,</span><span class="n">tree</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">shell</span><span class="p">:</span>
                        <span class="n">unioned_shell</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;unioned_solid_network_shell_</span><span class="si">{}</span><span class="s2">_tree_</span><span class="si">{}</span><span class="s2">.vtp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">net_id</span><span class="p">,</span><span class="n">tree</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">tet_success</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tetrahedralize    : PASS&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tetrahedralize    : Fail ---&gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tet_fail_list</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">surf_success</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Surface Extraction: PASS&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Surface Extraction: Fail ---&gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">surf_fail_list</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">tet_success</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Union             : PASS&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Union             : Fail ---&gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">union_fail_list</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">shell</span><span class="p">:</span>
            <span class="n">unioned_fix</span> <span class="o">=</span> <span class="n">pymeshfix</span><span class="o">.</span><span class="n">MeshFix</span><span class="p">(</span><span class="n">unioned</span><span class="p">)</span>
            <span class="n">unioned_fix</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">unioned</span> <span class="o">=</span> <span class="n">unioned_fix</span><span class="o">.</span><span class="n">mesh</span>
            <span class="n">unioned</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;partial_unioned_solid_network_</span><span class="si">{}</span><span class="s2">_tree_</span><span class="si">{}</span><span class="s2">.stl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">net_id</span><span class="p">,</span><span class="n">tree</span><span class="p">))</span>
            <span class="n">unioned_shell_fix</span> <span class="o">=</span> <span class="n">pymeshfix</span><span class="o">.</span><span class="n">MeshFix</span><span class="p">(</span><span class="n">unioned_shell</span><span class="p">)</span>
            <span class="n">unioned_shell_fix</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">unioned_shell</span> <span class="o">=</span> <span class="n">unioned_shell_fix</span><span class="o">.</span><span class="n">mesh</span>
            <span class="n">unioned_shell</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;unioned_solid_network_shell_</span><span class="si">{}</span><span class="s2">_tree_</span><span class="si">{}</span><span class="s2">.stl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">net_id</span><span class="p">,</span><span class="n">tree</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ALL_vessels</span><span class="p">,</span><span class="n">ALL_tets</span><span class="p">,</span><span class="n">ALL_surfs</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">unioned</span><span class="p">,</span><span class="n">ALL_vessel_shells</span><span class="p">,</span><span class="n">ALL_tet_shells</span><span class="p">,</span><span class="n">ALL_surf_shells</span><span class="p">,</span><span class="n">unioned_shell</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ALL_vessels</span><span class="p">,</span><span class="n">ALL_tets</span><span class="p">,</span><span class="n">ALL_surfs</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">unioned</span></div>

<div class="viewcode-block" id="forest.export"><a class="viewcode-back" href="../../svcco.html#svcco.tree.forest.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">make</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">spline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">write_splines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">spline_sample_points</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">steady</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">apply_distal_resistance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">ALL_POINTS</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ALL_RADII</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ALL_NORMALS</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ALL_INTERP_XYZ</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ALL_INTERP_RADII</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ALL_SPLINES</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">CONNECTED_COPY</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">desc1</span> <span class="o">=</span> <span class="s1">&#39;Extracting Data from Networks&#39;</span>
        <span class="n">desc1</span> <span class="o">=</span> <span class="n">desc1</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">40</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">desc1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">network</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_networks</span><span class="p">),</span><span class="n">bar_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{l_bar}{bar:10}{r_bar}{bar:-10b}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="n">desc1</span><span class="p">):</span>
            <span class="n">network_points</span>  <span class="o">=</span> <span class="p">[]</span>
            <span class="n">network_radii</span>   <span class="o">=</span> <span class="p">[]</span>
            <span class="n">network_normals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">network_endpoints</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">network_copy</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">network</span><span class="p">]):</span>
                <span class="n">tree_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="n">tr</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">tree_copy_terminals</span> <span class="o">=</span> <span class="n">tree_copy</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">tree_copy</span><span class="p">[:,</span><span class="mi">15</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),:]</span>
                <span class="n">tree_copy_terminals</span> <span class="o">=</span> <span class="n">tree_copy_terminals</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">tree_copy_terminals</span><span class="p">[:,</span><span class="mi">16</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">tree_copy</span><span class="p">[</span><span class="n">tree_copy_terminals</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tree_copy</span><span class="p">[</span><span class="n">tree_copy_terminals</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">tree_copy</span><span class="p">[</span><span class="n">tree_copy_terminals</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">tree_copy</span><span class="p">[</span><span class="n">tree_copy_terminals</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree_copy</span><span class="p">[</span><span class="n">tree_copy_terminals</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">max_vessel_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tree_copy</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">conn_parents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="n">tr</span><span class="p">][:,</span><span class="mi">17</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_vessel_id</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">tree_copy</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="n">tr</span><span class="p">][</span><span class="n">conn_parents</span><span class="p">,</span><span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="n">tr</span><span class="p">][</span><span class="n">conn_parents</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">tree_copy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tree_copy</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="n">tr</span><span class="p">]))</span>
                <span class="n">network_copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_copy</span><span class="p">)</span>
                <span class="c1">#tmp_tree = tree()</span>
                <span class="c1">#tmp_tree.data = tree_copy</span>
                <span class="c1">#tmp_tree.show()</span>

            <span class="k">for</span> <span class="n">tr</span><span class="p">,</span><span class="n">net</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">network_copy</span><span class="p">):</span>
                <span class="n">update</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="n">tr</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="n">tr</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">])</span>
                <span class="n">update_radii</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="n">tr</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Pperm&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="n">tr</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Pterm&#39;</span><span class="p">])</span>
                <span class="c1">#tmp_tree = tree()</span>
                <span class="c1">#tmp_tree.data = net</span>
                <span class="c1">#tmp_tree.show()</span>
            <span class="c1">#P = self.show()</span>
            <span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">network</span><span class="p">]</span>
            <span class="n">desc2</span> <span class="o">=</span> <span class="s1">&#39;Extracting Data from Network </span><span class="si">{}</span><span class="s1"> Trees&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
            <span class="n">desc2</span> <span class="o">=</span> <span class="n">desc2</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">40</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">desc2</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span><span class="n">bar_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{l_bar}{bar:10}{r_bar}{bar:-10b}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">position</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="n">desc2</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar_tree</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tree_copy</span> <span class="ow">in</span> <span class="n">network_copy</span><span class="p">:</span>
                    <span class="n">interp_xyz</span><span class="p">,</span><span class="n">interp_r</span><span class="p">,</span><span class="n">interp_n</span><span class="p">,</span><span class="n">frames</span><span class="p">,</span><span class="n">branches</span><span class="p">,</span><span class="n">interp_xyzr</span> <span class="o">=</span> <span class="n">get_interpolated_sv_data</span><span class="p">(</span><span class="n">tree_copy</span><span class="p">)</span>
                    <span class="n">points</span><span class="p">,</span><span class="n">radii</span><span class="p">,</span><span class="n">normals</span> <span class="o">=</span> <span class="n">sv_data</span><span class="p">(</span><span class="n">interp_xyzr</span><span class="p">,</span><span class="n">interp_r</span><span class="p">,</span><span class="n">radius_buffer</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
                    <span class="c1">#for p_list in points:</span>
                    <span class="c1">#    P.add_points(np.array(p_list),render_points_as_spheres=True,color=&#39;g&#39;,point_size=30)</span>
                    <span class="n">network_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
                    <span class="n">network_radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
                    <span class="n">network_normals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normals</span><span class="p">)</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
                    <span class="n">network_endpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
                    <span class="c1">#P.show()</span>
                    <span class="n">pbar_tree</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">CONNECTED_COPY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">network_copy</span><span class="p">)</span>

            <span class="c1"># Calculate Vessel Reordering relative to the first vessel of the network</span>
            <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">network_endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">])))]</span>
            <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">network</span><span class="p">]):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">order</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1">#tmp.append(np.argwhere(np.all(np.isclose(e[0][0],network_endpoints[]),axis=1)).flatten()[0])</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">network_endpoints</span><span class="p">[</span><span class="n">tree</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">network_endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]))</span>
                <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="c1"># Reorder Vessels</span>
            <span class="n">reordered_points</span>  <span class="o">=</span> <span class="p">[]</span>
            <span class="n">reordered_radii</span>   <span class="o">=</span> <span class="p">[]</span>
            <span class="n">reordered_normals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">network</span><span class="p">]):</span>
                <span class="n">tmp_points</span>  <span class="o">=</span> <span class="p">[]</span>
                <span class="n">tmp_radii</span>   <span class="o">=</span> <span class="p">[]</span>
                <span class="n">tmp_normals</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">order</span><span class="p">[</span><span class="n">tree</span><span class="p">]:</span>
                    <span class="n">tmp_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">network_points</span><span class="p">[</span><span class="n">tree</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
                    <span class="n">tmp_radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">network_radii</span><span class="p">[</span><span class="n">tree</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
                    <span class="n">tmp_normals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">network_normals</span><span class="p">[</span><span class="n">tree</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
                <span class="n">reordered_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_points</span><span class="p">)</span>
                <span class="n">reordered_radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_radii</span><span class="p">)</span>
                <span class="n">reordered_normals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_normals</span><span class="p">)</span>
                <span class="c1">#print(&#39;reorder: {}&#39;.format(len(reordered_points[-1])))</span>
            <span class="c1"># Reverse and Combine</span>
            <span class="n">final_points</span>  <span class="o">=</span> <span class="p">[</span><span class="n">reordered_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">final_radii</span>   <span class="o">=</span> <span class="p">[</span><span class="n">reordered_radii</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">final_normals</span> <span class="o">=</span> <span class="p">[</span><span class="n">reordered_normals</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">final_interp_xyz</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">final_interp_radii</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">network</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">tree</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reordered_points</span><span class="p">[</span><span class="n">tree</span><span class="p">])):</span>
                        <span class="n">vessel_normals_flip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reordered_normals</span><span class="p">[</span><span class="n">tree</span><span class="p">][</span><span class="n">vessel</span><span class="p">])</span><span class="o">*-</span><span class="mi">1</span>
                        <span class="n">reordered_normals</span><span class="p">[</span><span class="n">tree</span><span class="p">][</span><span class="n">vessel</span><span class="p">]</span> <span class="o">=</span> <span class="n">vessel_normals_flip</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">final_points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">reordered_points</span><span class="p">[</span><span class="n">tree</span><span class="p">][</span><span class="n">vessel</span><span class="p">]))[</span><span class="mi">2</span><span class="p">:])</span> <span class="c1">#changed</span>
                        <span class="n">final_radii</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">reordered_radii</span><span class="p">[</span><span class="n">tree</span><span class="p">][</span><span class="n">vessel</span><span class="p">]))[</span><span class="mi">2</span><span class="p">:])</span> <span class="c1">#changed</span>
                        <span class="n">final_normals</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">reordered_normals</span><span class="p">[</span><span class="n">tree</span><span class="p">][</span><span class="n">vessel</span><span class="p">]))[</span><span class="mi">2</span><span class="p">:])</span> <span class="c1">#changed 9-8-22</span>
                        <span class="c1">#make the connecting contours have equal average radii</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp_points</span>  <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">tmp_radii</span>   <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">tmp_normals</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reordered_points</span><span class="p">[</span><span class="n">tree</span><span class="p">])):</span>
                        <span class="n">tmp_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">reordered_points</span><span class="p">[</span><span class="n">tree</span><span class="p">][</span><span class="n">vessel</span><span class="p">])))</span>
                        <span class="n">tmp_radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">reordered_radii</span><span class="p">[</span><span class="n">tree</span><span class="p">][</span><span class="n">vessel</span><span class="p">])))</span>
                        <span class="n">tmp_normals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">reordered_normals</span><span class="p">[</span><span class="n">tree</span><span class="p">][</span><span class="n">vessel</span><span class="p">])))</span>
                        <span class="c1"># make sure the radii is less than the average radii of the first vessel</span>
                    <span class="n">final_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_points</span><span class="p">)</span>
                    <span class="n">final_radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_radii</span><span class="p">)</span>
                    <span class="n">final_normals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_normals</span><span class="p">)</span>
                <span class="n">interp_xyz</span>  <span class="o">=</span> <span class="p">[]</span>
                <span class="n">interp_r</span>    <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">final_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
                    <span class="k">pass</span>
                    <span class="c1">#P.add_points(np.array(final_points[-1][vessel]),render_points_as_spheres=True,color=&#39;g&#39;,point_size=30)</span>
                    <span class="c1">#interp_xyz.append(splprep(np.array(final_points[-1][vessel]).T,s=0))</span>
                    <span class="c1">#r = np.vstack((interp_xyz[-1][1],np.array(final_radii[-1][vessel]).T))</span>
                    <span class="c1">#interp_r.append(splprep(r,s=0))</span>
                <span class="n">final_interp_xyz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp_xyz</span><span class="p">)</span>
                <span class="n">final_interp_radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp_r</span><span class="p">)</span>
            <span class="c1">#P.show()</span>
            <span class="n">ALL_POINTS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_points</span><span class="p">)</span>
            <span class="n">ALL_RADII</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_radii</span><span class="p">)</span>
            <span class="n">ALL_NORMALS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_normals</span><span class="p">)</span>
            <span class="n">ALL_INTERP_XYZ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_interp_xyz</span><span class="p">)</span>
            <span class="n">ALL_INTERP_RADII</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_interp_radii</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ALL_POINTS</span> <span class="o">=</span> <span class="n">ALL_POINTS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ALL_RADII</span> <span class="o">=</span> <span class="n">ALL_RADII</span>
            <span class="c1"># Export Components of Network to SV Builder for Code Generation</span>
            <span class="k">if</span> <span class="n">make</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">final_points</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">steady</span><span class="p">:</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">flow</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">22</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">22</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">time</span><span class="p">,</span><span class="n">flow</span> <span class="o">=</span> <span class="n">wave</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">22</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># changed wave function</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">flow</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">apply_distal_resistance</span><span class="p">:</span>
                        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Pterm&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">22</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">R</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">num_caps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees_per_network</span><span class="p">[</span><span class="n">network</span><span class="p">]</span>
                    <span class="n">options</span> <span class="o">=</span> <span class="n">file_options</span><span class="p">(</span><span class="n">num_caps</span><span class="p">,</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span><span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="n">gui</span><span class="p">,</span><span class="n">distal_resistance</span><span class="o">=</span><span class="n">R</span><span class="p">)</span>
                    <span class="n">build</span><span class="p">(</span><span class="n">final_points</span><span class="p">[</span><span class="n">component</span><span class="p">],</span><span class="n">final_radii</span><span class="p">[</span><span class="n">component</span><span class="p">],</span><span class="n">final_normals</span><span class="p">[</span><span class="n">component</span><span class="p">],</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spline</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">network</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ALL_POINTS</span><span class="p">)):</span>
                <span class="n">network_splines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ALL_POINTS</span><span class="p">[</span><span class="n">network</span><span class="p">])):</span>
                    <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ALL_POINTS</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="n">tree</span><span class="p">])):</span>
                        <span class="n">pt_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ALL_POINTS</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="n">tree</span><span class="p">][</span><span class="n">vessel</span><span class="p">])</span>
                        <span class="n">r_array</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ALL_RADII</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="n">tree</span><span class="p">][</span><span class="n">vessel</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">pt_r_combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">pt_array</span><span class="p">,</span><span class="n">r_array</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">pt_r_combined</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                        <span class="n">vessel_ctr</span> <span class="o">=</span> <span class="n">splprep</span><span class="p">(</span><span class="n">pt_r_combined</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">vessel_spline</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">splev</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">vessel_ctr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">network_splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel_spline</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">write_splines</span><span class="p">:</span>
                    <span class="n">spline_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;network_</span><span class="si">{}</span><span class="s2">_b_splines.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">network</span><span class="p">),</span><span class="s2">&quot;w+&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">vessel_spline</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">network_splines</span><span class="p">):</span>
                        <span class="n">spline_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Vessel: </span><span class="si">{}</span><span class="s1">, Number of Points: </span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">spline_sample_points</span><span class="p">))</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">spline_sample_points</span><span class="p">)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">vessel_spline</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spline_sample_points</span><span class="p">):</span>
                            <span class="n">spline_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">k</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
                        <span class="n">spline_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">spline_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">ALL_SPLINES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">network_splines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_points</span><span class="p">,</span><span class="n">final_radii</span><span class="p">,</span><span class="n">final_normals</span><span class="p">,</span><span class="n">CONNECTED_COPY</span><span class="p">,</span><span class="n">ALL_INTERP_XYZ</span><span class="p">,</span><span class="n">ALL_INTERP_RADII</span><span class="p">,</span><span class="n">ALL_SPLINES</span></div></div>

<div class="viewcode-block" id="perfusion_territory"><a class="viewcode-back" href="../../svcco.html#svcco.tree.perfusion_territory">[docs]</a><span class="k">def</span> <span class="nf">perfusion_territory</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="n">subdivisions</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">mesh_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tree_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">terminals</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">tree</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">15</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,:]</span>
    <span class="n">terminals</span> <span class="o">=</span> <span class="n">terminals</span><span class="p">[</span><span class="n">terminals</span><span class="p">[:,</span><span class="mi">16</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,:]</span>
    <span class="n">territory_id</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">territory_volumes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">terminals</span><span class="p">))</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">tet</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">compute_cell_sizes</span><span class="p">()</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span>
    <span class="c1">#for idx, cell_center in tqdm(enumerate(tree.boundary.tet.grid.cell_centers().points),desc=&#39;Calculating Perfusion Territories&#39;):</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cell_center</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">tet</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">cell_centers</span><span class="p">()</span><span class="o">.</span><span class="n">points</span><span class="p">):</span>
        <span class="n">closest_terminal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cell_center</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">terminals</span><span class="p">[:,</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">territory_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">closest_terminal</span><span class="p">)</span>
        <span class="n">territory_volumes</span><span class="p">[</span><span class="n">closest_terminal</span><span class="p">]</span> <span class="o">+=</span> <span class="n">vol</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">territory_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">territory_id</span><span class="p">)</span>
    <span class="n">tree</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">tet</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s1">&#39;perfusion_territory_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">territory_id</span>
    <span class="k">if</span> <span class="n">mesh_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tree</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">tet</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tree</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">tet</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;example.vtu&#39;</span><span class="p">)</span>
    <span class="n">models</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">append</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkAppendPolyData</span><span class="p">()</span>
    <span class="c1">#append.UserManagedInputsOn()</span>
    <span class="c1">#append.SetInputDataObject(models[0])</span>
    <span class="c1">#append.SetNumberOfInputs(len(models))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)):</span>
        <span class="n">append</span><span class="o">.</span><span class="n">AddInputData</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
    <span class="n">append</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">total_tree</span> <span class="o">=</span> <span class="n">append</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">tree_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">tree_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s1">&#39;example_tree.vtp&#39;</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">SetInputDataObject</span><span class="p">(</span><span class="n">total_tree</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">territory_id</span><span class="p">,</span><span class="n">territory_volumes</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">territory_volumes</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SVCCO 0.5.52 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">svcco.tree</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Zachary Sexton.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>